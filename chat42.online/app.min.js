window.alert=ons.notification.alert;function include(file){document.writeln("<script type='text/javascript' src='"+file+'?r='+C.rand+"'></script>");}
function isPromise(value){return Boolean(value&&typeof value.then==='function');}
function expand_class(origin,additional){var arr=document.getElementsByClassName(origin);for(var i=0;i<arr.length;i++){var el=arr[i];el.className+=' '+additional}}
function save_scope(scope,func){return function(){func.apply(scope,arguments);}}
function initScope(obj,scope){if(typeof(scope)!=='object')return;for(var key in scope){if(!scope.hasOwnProperty(key))continue;obj[key]=scope[key];}}
htmlEntities_obj=null;function htmlEntities(str){if(htmlEntities_obj===null){htmlEntities_obj=document.createElement('div');}
htmlEntities_obj.appendChild(document.createTextNode(str));str=htmlEntities_obj.innerHTML;htmlEntities_obj.removeChild(htmlEntities_obj.firstChild);return str;}
function fix4android(){expand_class('segment','segment--material');expand_class('segment__item','segment--material__item');expand_class('segment__input','segment--material__input');expand_class('segment__button','segment--material__button');}
function dataURLtoBlob(dataurl){var arr=dataurl.split(','),mime=arr[0].match(/:(.*?);/)[1],bstr=atob(arr[1]),n=bstr.length,u8arr=new Uint8Array(n);while(n--){u8arr[n]=bstr.charCodeAt(n);}
return new Blob([u8arr],{type:mime});}
function press_back_button(){var event=new Event('backbutton');window.document.dispatchEvent(event);}
(function(){var throttle=function(type,name,obj){obj=obj||window;var running=false;var func=function(){if(running){return;}
running=true;requestAnimationFrame(function(){obj.dispatchEvent(new CustomEvent(name));running=false;});};obj.addEventListener(type,func);};throttle("resize","optimizedResize");})();function stat(group,action,label,value){if(!group||!action)throw "grooup && action are required";var data={hitType:'event',eventCategory:group,eventAction:action};if(label)data.eventLabel=label;if(value)data.eventValue=value;if(typeof(ga)!=='undefined'){ga('send',data);}else{}}
var __url=document.createElement('a');__url.href=window.location.href;if(window.location.host.indexOf("r.")===0){window.location.href=window.location.protocol+"//"+window.location.host.substr(2)+"/r"+__url.search;}
EVENT={CHAT_STATE_CHANGED:1,MESSAGE_RECEIVED:2,MESSAGE_SENT:3,MESSAGE_SYSTEM:4,STRANGER_TYPING:5,STRANGER_NOT_TYPING:6,CHAT_STARTED:7,CHAT_RESTORED:8,THEME_CHANGED:9};function NewClientInitMessage(){var msg=protos.ClientInit.create();msg.Proto=protos.PROTO._CLIENT_INIT;msg.Version=C.version;msg.Platform=State.getPlatform();msg.Nickname=DataStorage.getLocal("nickname",'');msg.FirstLaunch=DataStorage.getLocal("first_launch",-1);msg.SessionId=DataStorage.get(C.sess_cookie_name,"");msg.SessionSecret=DataStorage.get(C.sess_cookie_name+"s","");if(typeof(Native)!=='undefined'&&Native.getAppVersion){native=protos.NativeAppInfo.create();native.BuildNumber=Native.getAppBuild();native.VersionName=Native.getAppVersion();native.PackageName=Native.getAppPackage();msg.AppInfo=native;}
return msg;}
(function(global,factory){protos=factory(protobuf).protos;if(typeof define==='function'&&define.amd)
define(["protobufjs/minimal"],factory);else if(typeof require==='function'&&typeof module==='object'&&module&&module.exports)
module.exports=factory(require("protobufjs/minimal"));})(this,function($protobuf){"use strict";var $Reader=$protobuf.Reader,$Writer=$protobuf.Writer,$util=$protobuf.util;var $root=$protobuf.roots["default"]||($protobuf.roots["default"]={});$root.protos=(function(){var protos={};protos.STATE=(function(){var valuesById={},values=Object.create(valuesById);values[valuesById[0]="FAIL"]=0;values[valuesById[1]="INIT"]=1;values[valuesById[2]="LOOKING_FOR_OPPONENT"]=2;values[valuesById[3]="CHAT_IN_PROGRESS"]=3;values[valuesById[4]="IDLE"]=4;values[valuesById[5]="MESSAGE"]=5;values[valuesById[6]="LOOK_FOR_NEXT_CHAT"]=6;values[valuesById[7]="STRANGER_HAS_LEFT"]=7;values[valuesById[8]="QUIT"]=8;values[valuesById[9]="STRANGER_DISCONNECTED"]=9;values[valuesById[10]="CHAT_RESTORED"]=10;values[valuesById[11]="REFRESH_UI"]=11;values[valuesById[12]="PING"]=12;values[valuesById[13]="PONG"]=13;values[valuesById[14]="USER_IS_TYPING"]=14;values[valuesById[15]="USER_NOT_TYPING"]=15;values[valuesById[16]="REPORT"]=16;values[valuesById[17]="RESTORE_BY_CHAT_CODE"]=17;values[valuesById[18]="CMD_TRANSFER_HISTORY"]=18;values[valuesById[19]="DIALOG_HISTORY"]=19;values[valuesById[20]="DISCONNECT"]=20;return values;})();protos.PLATFORM=(function(){var valuesById={},values=Object.create(valuesById);values[valuesById[0]="WEB"]=0;values[valuesById[1]="IOS"]=1;values[valuesById[2]="ANDROID"]=2;return values;})();protos.PROTO=(function(){var valuesById={},values=Object.create(valuesById);values[valuesById[0]="_BASE"]=0;values[valuesById[1]="_CLIENT_INIT"]=1;values[valuesById[2]="_MESSAGE"]=2;values[valuesById[3]="_PING"]=3;values[valuesById[4]="_REPORT"]=4;values[valuesById[5]="_SERVER_STATE_CHANGE"]=5;return values;})();protos.NativeAppInfo=(function(){function NativeAppInfo(properties){if(properties)
for(var keys=Object.keys(properties),i=0;i<keys.length;++i)
if(properties[keys[i]]!=null)
this[keys[i]]=properties[keys[i]];}
NativeAppInfo.prototype.BuildNumber=0;NativeAppInfo.prototype.VersionName="";NativeAppInfo.prototype.PackageName="";NativeAppInfo.create=function create(properties){return new NativeAppInfo(properties);};NativeAppInfo.encode=function encode(message,writer){if(!writer)
writer=$Writer.create();if(message.BuildNumber!=null&&message.hasOwnProperty("BuildNumber"))
writer.uint32(8).uint32(message.BuildNumber);if(message.VersionName!=null&&message.hasOwnProperty("VersionName"))
writer.uint32(18).string(message.VersionName);if(message.PackageName!=null&&message.hasOwnProperty("PackageName"))
writer.uint32(26).string(message.PackageName);return writer;};NativeAppInfo.encodeDelimited=function encodeDelimited(message,writer){return this.encode(message,writer).ldelim();};NativeAppInfo.decode=function decode(reader,length){if(!(reader instanceof $Reader))
reader=$Reader.create(reader);var end=length===undefined?reader.len:reader.pos+length,message=new $root.protos.NativeAppInfo();while(reader.pos<end){var tag=reader.uint32();switch(tag>>>3){case 1:message.BuildNumber=reader.uint32();break;case 2:message.VersionName=reader.string();break;case 3:message.PackageName=reader.string();break;default:reader.skipType(tag&7);break;}}
return message;};NativeAppInfo.decodeDelimited=function decodeDelimited(reader){if(!(reader instanceof $Reader))
reader=new $Reader(reader);return this.decode(reader,reader.uint32());};NativeAppInfo.verify=function verify(message){if(typeof message!=="object"||message===null)
return "object expected";if(message.BuildNumber!=null&&message.hasOwnProperty("BuildNumber"))
if(!$util.isInteger(message.BuildNumber))
return "BuildNumber: integer expected";if(message.VersionName!=null&&message.hasOwnProperty("VersionName"))
if(!$util.isString(message.VersionName))
return "VersionName: string expected";if(message.PackageName!=null&&message.hasOwnProperty("PackageName"))
if(!$util.isString(message.PackageName))
return "PackageName: string expected";return null;};NativeAppInfo.fromObject=function fromObject(object){if(object instanceof $root.protos.NativeAppInfo)
return object;var message=new $root.protos.NativeAppInfo();if(object.BuildNumber!=null)
message.BuildNumber=object.BuildNumber>>>0;if(object.VersionName!=null)
message.VersionName=String(object.VersionName);if(object.PackageName!=null)
message.PackageName=String(object.PackageName);return message;};NativeAppInfo.toObject=function toObject(message,options){if(!options)
options={};var object={};if(options.defaults){object.BuildNumber=0;object.VersionName="";object.PackageName="";}
if(message.BuildNumber!=null&&message.hasOwnProperty("BuildNumber"))
object.BuildNumber=message.BuildNumber;if(message.VersionName!=null&&message.hasOwnProperty("VersionName"))
object.VersionName=message.VersionName;if(message.PackageName!=null&&message.hasOwnProperty("PackageName"))
object.PackageName=message.PackageName;return object;};NativeAppInfo.prototype.toJSON=function toJSON(){return this.constructor.toObject(this,$protobuf.util.toJSONOptions);};return NativeAppInfo;})();protos.Base=(function(){function Base(properties){if(properties)
for(var keys=Object.keys(properties),i=0;i<keys.length;++i)
if(properties[keys[i]]!=null)
this[keys[i]]=properties[keys[i]];}
Base.prototype.Proto=0;Base.prototype.State=0;Base.create=function create(properties){return new Base(properties);};Base.encode=function encode(message,writer){if(!writer)
writer=$Writer.create();if(message.Proto!=null&&message.hasOwnProperty("Proto"))
writer.uint32(8).int32(message.Proto);if(message.State!=null&&message.hasOwnProperty("State"))
writer.uint32(16).int32(message.State);return writer;};Base.encodeDelimited=function encodeDelimited(message,writer){return this.encode(message,writer).ldelim();};Base.decode=function decode(reader,length){if(!(reader instanceof $Reader))
reader=$Reader.create(reader);var end=length===undefined?reader.len:reader.pos+length,message=new $root.protos.Base();while(reader.pos<end){var tag=reader.uint32();switch(tag>>>3){case 1:message.Proto=reader.int32();break;case 2:message.State=reader.int32();break;default:reader.skipType(tag&7);break;}}
return message;};Base.decodeDelimited=function decodeDelimited(reader){if(!(reader instanceof $Reader))
reader=new $Reader(reader);return this.decode(reader,reader.uint32());};Base.verify=function verify(message){if(typeof message!=="object"||message===null)
return "object expected";if(message.Proto!=null&&message.hasOwnProperty("Proto"))
switch(message.Proto){default:return "Proto: enum value expected";case 0:case 1:case 2:case 3:case 4:case 5:break;}
if(message.State!=null&&message.hasOwnProperty("State"))
switch(message.State){default:return "State: enum value expected";case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 9:case 10:case 11:case 12:case 13:case 14:case 15:case 16:case 17:case 18:case 19:case 20:break;}
return null;};Base.fromObject=function fromObject(object){if(object instanceof $root.protos.Base)
return object;var message=new $root.protos.Base();switch(object.Proto){case "_BASE":case 0:message.Proto=0;break;case "_CLIENT_INIT":case 1:message.Proto=1;break;case "_MESSAGE":case 2:message.Proto=2;break;case "_PING":case 3:message.Proto=3;break;case "_REPORT":case 4:message.Proto=4;break;case "_SERVER_STATE_CHANGE":case 5:message.Proto=5;break;}
switch(object.State){case "FAIL":case 0:message.State=0;break;case "INIT":case 1:message.State=1;break;case "LOOKING_FOR_OPPONENT":case 2:message.State=2;break;case "CHAT_IN_PROGRESS":case 3:message.State=3;break;case "IDLE":case 4:message.State=4;break;case "MESSAGE":case 5:message.State=5;break;case "LOOK_FOR_NEXT_CHAT":case 6:message.State=6;break;case "STRANGER_HAS_LEFT":case 7:message.State=7;break;case "QUIT":case 8:message.State=8;break;case "STRANGER_DISCONNECTED":case 9:message.State=9;break;case "CHAT_RESTORED":case 10:message.State=10;break;case "REFRESH_UI":case 11:message.State=11;break;case "PING":case 12:message.State=12;break;case "PONG":case 13:message.State=13;break;case "USER_IS_TYPING":case 14:message.State=14;break;case "USER_NOT_TYPING":case 15:message.State=15;break;case "REPORT":case 16:message.State=16;break;case "RESTORE_BY_CHAT_CODE":case 17:message.State=17;break;case "CMD_TRANSFER_HISTORY":case 18:message.State=18;break;case "DIALOG_HISTORY":case 19:message.State=19;break;case "DISCONNECT":case 20:message.State=20;break;}
return message;};Base.toObject=function toObject(message,options){if(!options)
options={};var object={};if(options.defaults){object.Proto=options.enums===String?"_BASE":0;object.State=options.enums===String?"FAIL":0;}
if(message.Proto!=null&&message.hasOwnProperty("Proto"))
object.Proto=options.enums===String?$root.protos.PROTO[message.Proto]:message.Proto;if(message.State!=null&&message.hasOwnProperty("State"))
object.State=options.enums===String?$root.protos.STATE[message.State]:message.State;return object;};Base.prototype.toJSON=function toJSON(){return this.constructor.toObject(this,$protobuf.util.toJSONOptions);};return Base;})();protos.ClientInit=(function(){function ClientInit(properties){if(properties)
for(var keys=Object.keys(properties),i=0;i<keys.length;++i)
if(properties[keys[i]]!=null)
this[keys[i]]=properties[keys[i]];}
ClientInit.prototype.Proto=0;ClientInit.prototype.State=0;ClientInit.prototype.SessionId="";ClientInit.prototype.SessionSecret="";ClientInit.prototype.OpponentId="";ClientInit.prototype.Version="";ClientInit.prototype.Platform=0;ClientInit.prototype.AppInfo=null;ClientInit.prototype.Nickname="";ClientInit.prototype.FirstLaunch=$util.Long?$util.Long.fromBits(0,0,true):0;ClientInit.create=function create(properties){return new ClientInit(properties);};ClientInit.encode=function encode(message,writer){if(!writer)
writer=$Writer.create();if(message.Proto!=null&&message.hasOwnProperty("Proto"))
writer.uint32(8).int32(message.Proto);if(message.State!=null&&message.hasOwnProperty("State"))
writer.uint32(16).int32(message.State);if(message.SessionId!=null&&message.hasOwnProperty("SessionId"))
writer.uint32(26).string(message.SessionId);if(message.SessionSecret!=null&&message.hasOwnProperty("SessionSecret"))
writer.uint32(34).string(message.SessionSecret);if(message.OpponentId!=null&&message.hasOwnProperty("OpponentId"))
writer.uint32(42).string(message.OpponentId);if(message.Version!=null&&message.hasOwnProperty("Version"))
writer.uint32(50).string(message.Version);if(message.Platform!=null&&message.hasOwnProperty("Platform"))
writer.uint32(56).int32(message.Platform);if(message.AppInfo!=null&&message.hasOwnProperty("AppInfo"))
$root.protos.NativeAppInfo.encode(message.AppInfo,writer.uint32(66).fork()).ldelim();if(message.Nickname!=null&&message.hasOwnProperty("Nickname"))
writer.uint32(74).string(message.Nickname);if(message.FirstLaunch!=null&&message.hasOwnProperty("FirstLaunch"))
writer.uint32(80).uint64(message.FirstLaunch);return writer;};ClientInit.encodeDelimited=function encodeDelimited(message,writer){return this.encode(message,writer).ldelim();};ClientInit.decode=function decode(reader,length){if(!(reader instanceof $Reader))
reader=$Reader.create(reader);var end=length===undefined?reader.len:reader.pos+length,message=new $root.protos.ClientInit();while(reader.pos<end){var tag=reader.uint32();switch(tag>>>3){case 1:message.Proto=reader.int32();break;case 2:message.State=reader.int32();break;case 3:message.SessionId=reader.string();break;case 4:message.SessionSecret=reader.string();break;case 5:message.OpponentId=reader.string();break;case 6:message.Version=reader.string();break;case 7:message.Platform=reader.int32();break;case 8:message.AppInfo=$root.protos.NativeAppInfo.decode(reader,reader.uint32());break;case 9:message.Nickname=reader.string();break;case 10:message.FirstLaunch=reader.uint64();break;default:reader.skipType(tag&7);break;}}
return message;};ClientInit.decodeDelimited=function decodeDelimited(reader){if(!(reader instanceof $Reader))
reader=new $Reader(reader);return this.decode(reader,reader.uint32());};ClientInit.verify=function verify(message){if(typeof message!=="object"||message===null)
return "object expected";if(message.Proto!=null&&message.hasOwnProperty("Proto"))
switch(message.Proto){default:return "Proto: enum value expected";case 0:case 1:case 2:case 3:case 4:case 5:break;}
if(message.State!=null&&message.hasOwnProperty("State"))
switch(message.State){default:return "State: enum value expected";case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 9:case 10:case 11:case 12:case 13:case 14:case 15:case 16:case 17:case 18:case 19:case 20:break;}
if(message.SessionId!=null&&message.hasOwnProperty("SessionId"))
if(!$util.isString(message.SessionId))
return "SessionId: string expected";if(message.SessionSecret!=null&&message.hasOwnProperty("SessionSecret"))
if(!$util.isString(message.SessionSecret))
return "SessionSecret: string expected";if(message.OpponentId!=null&&message.hasOwnProperty("OpponentId"))
if(!$util.isString(message.OpponentId))
return "OpponentId: string expected";if(message.Version!=null&&message.hasOwnProperty("Version"))
if(!$util.isString(message.Version))
return "Version: string expected";if(message.Platform!=null&&message.hasOwnProperty("Platform"))
switch(message.Platform){default:return "Platform: enum value expected";case 0:case 1:case 2:break;}
if(message.AppInfo!=null&&message.hasOwnProperty("AppInfo")){var error=$root.protos.NativeAppInfo.verify(message.AppInfo);if(error)
return "AppInfo."+error;}
if(message.Nickname!=null&&message.hasOwnProperty("Nickname"))
if(!$util.isString(message.Nickname))
return "Nickname: string expected";if(message.FirstLaunch!=null&&message.hasOwnProperty("FirstLaunch"))
if(!$util.isInteger(message.FirstLaunch)&&!(message.FirstLaunch&&$util.isInteger(message.FirstLaunch.low)&&$util.isInteger(message.FirstLaunch.high)))
return "FirstLaunch: integer|Long expected";return null;};ClientInit.fromObject=function fromObject(object){if(object instanceof $root.protos.ClientInit)
return object;var message=new $root.protos.ClientInit();switch(object.Proto){case "_BASE":case 0:message.Proto=0;break;case "_CLIENT_INIT":case 1:message.Proto=1;break;case "_MESSAGE":case 2:message.Proto=2;break;case "_PING":case 3:message.Proto=3;break;case "_REPORT":case 4:message.Proto=4;break;case "_SERVER_STATE_CHANGE":case 5:message.Proto=5;break;}
switch(object.State){case "FAIL":case 0:message.State=0;break;case "INIT":case 1:message.State=1;break;case "LOOKING_FOR_OPPONENT":case 2:message.State=2;break;case "CHAT_IN_PROGRESS":case 3:message.State=3;break;case "IDLE":case 4:message.State=4;break;case "MESSAGE":case 5:message.State=5;break;case "LOOK_FOR_NEXT_CHAT":case 6:message.State=6;break;case "STRANGER_HAS_LEFT":case 7:message.State=7;break;case "QUIT":case 8:message.State=8;break;case "STRANGER_DISCONNECTED":case 9:message.State=9;break;case "CHAT_RESTORED":case 10:message.State=10;break;case "REFRESH_UI":case 11:message.State=11;break;case "PING":case 12:message.State=12;break;case "PONG":case 13:message.State=13;break;case "USER_IS_TYPING":case 14:message.State=14;break;case "USER_NOT_TYPING":case 15:message.State=15;break;case "REPORT":case 16:message.State=16;break;case "RESTORE_BY_CHAT_CODE":case 17:message.State=17;break;case "CMD_TRANSFER_HISTORY":case 18:message.State=18;break;case "DIALOG_HISTORY":case 19:message.State=19;break;case "DISCONNECT":case 20:message.State=20;break;}
if(object.SessionId!=null)
message.SessionId=String(object.SessionId);if(object.SessionSecret!=null)
message.SessionSecret=String(object.SessionSecret);if(object.OpponentId!=null)
message.OpponentId=String(object.OpponentId);if(object.Version!=null)
message.Version=String(object.Version);switch(object.Platform){case "WEB":case 0:message.Platform=0;break;case "IOS":case 1:message.Platform=1;break;case "ANDROID":case 2:message.Platform=2;break;}
if(object.AppInfo!=null){if(typeof object.AppInfo!=="object")
throw TypeError(".protos.ClientInit.AppInfo: object expected");message.AppInfo=$root.protos.NativeAppInfo.fromObject(object.AppInfo);}
if(object.Nickname!=null)
message.Nickname=String(object.Nickname);if(object.FirstLaunch!=null)
if($util.Long)
(message.FirstLaunch=$util.Long.fromValue(object.FirstLaunch)).unsigned=true;else if(typeof object.FirstLaunch==="string")
message.FirstLaunch=parseInt(object.FirstLaunch,10);else if(typeof object.FirstLaunch==="number")
message.FirstLaunch=object.FirstLaunch;else if(typeof object.FirstLaunch==="object")
message.FirstLaunch=new $util.LongBits(object.FirstLaunch.low>>>0,object.FirstLaunch.high>>>0).toNumber(true);return message;};ClientInit.toObject=function toObject(message,options){if(!options)
options={};var object={};if(options.defaults){object.Proto=options.enums===String?"_BASE":0;object.State=options.enums===String?"FAIL":0;object.SessionId="";object.SessionSecret="";object.OpponentId="";object.Version="";object.Platform=options.enums===String?"WEB":0;object.AppInfo=null;object.Nickname="";if($util.Long){var long=new $util.Long(0,0,true);object.FirstLaunch=options.longs===String?long.toString():options.longs===Number?long.toNumber():long;}else
object.FirstLaunch=options.longs===String?"0":0;}
if(message.Proto!=null&&message.hasOwnProperty("Proto"))
object.Proto=options.enums===String?$root.protos.PROTO[message.Proto]:message.Proto;if(message.State!=null&&message.hasOwnProperty("State"))
object.State=options.enums===String?$root.protos.STATE[message.State]:message.State;if(message.SessionId!=null&&message.hasOwnProperty("SessionId"))
object.SessionId=message.SessionId;if(message.SessionSecret!=null&&message.hasOwnProperty("SessionSecret"))
object.SessionSecret=message.SessionSecret;if(message.OpponentId!=null&&message.hasOwnProperty("OpponentId"))
object.OpponentId=message.OpponentId;if(message.Version!=null&&message.hasOwnProperty("Version"))
object.Version=message.Version;if(message.Platform!=null&&message.hasOwnProperty("Platform"))
object.Platform=options.enums===String?$root.protos.PLATFORM[message.Platform]:message.Platform;if(message.AppInfo!=null&&message.hasOwnProperty("AppInfo"))
object.AppInfo=$root.protos.NativeAppInfo.toObject(message.AppInfo,options);if(message.Nickname!=null&&message.hasOwnProperty("Nickname"))
object.Nickname=message.Nickname;if(message.FirstLaunch!=null&&message.hasOwnProperty("FirstLaunch"))
if(typeof message.FirstLaunch==="number")
object.FirstLaunch=options.longs===String?String(message.FirstLaunch):message.FirstLaunch;else
object.FirstLaunch=options.longs===String?$util.Long.prototype.toString.call(message.FirstLaunch):options.longs===Number?new $util.LongBits(message.FirstLaunch.low>>>0,message.FirstLaunch.high>>>0).toNumber(true):message.FirstLaunch;return object;};ClientInit.prototype.toJSON=function toJSON(){return this.constructor.toObject(this,$protobuf.util.toJSONOptions);};return ClientInit;})();protos.History=(function(){function History(properties){this.Messages=[];if(properties)
for(var keys=Object.keys(properties),i=0;i<keys.length;++i)
if(properties[keys[i]]!=null)
this[keys[i]]=properties[keys[i]];}
History.prototype.Proto=0;History.prototype.State=0;History.prototype.OpponentId="";History.prototype.NextMsgId=0;History.prototype.Messages=$util.emptyArray;History.create=function create(properties){return new History(properties);};History.encode=function encode(message,writer){if(!writer)
writer=$Writer.create();if(message.Proto!=null&&message.hasOwnProperty("Proto"))
writer.uint32(8).int32(message.Proto);if(message.State!=null&&message.hasOwnProperty("State"))
writer.uint32(16).int32(message.State);if(message.OpponentId!=null&&message.hasOwnProperty("OpponentId"))
writer.uint32(26).string(message.OpponentId);if(message.NextMsgId!=null&&message.hasOwnProperty("NextMsgId"))
writer.uint32(32).uint32(message.NextMsgId);if(message.Messages!=null&&message.Messages.length)
for(var i=0;i<message.Messages.length;++i)
$root.protos.Message.encode(message.Messages[i],writer.uint32(42).fork()).ldelim();return writer;};History.encodeDelimited=function encodeDelimited(message,writer){return this.encode(message,writer).ldelim();};History.decode=function decode(reader,length){if(!(reader instanceof $Reader))
reader=$Reader.create(reader);var end=length===undefined?reader.len:reader.pos+length,message=new $root.protos.History();while(reader.pos<end){var tag=reader.uint32();switch(tag>>>3){case 1:message.Proto=reader.int32();break;case 2:message.State=reader.int32();break;case 3:message.OpponentId=reader.string();break;case 4:message.NextMsgId=reader.uint32();break;case 5:if(!(message.Messages&&message.Messages.length))
message.Messages=[];message.Messages.push($root.protos.Message.decode(reader,reader.uint32()));break;default:reader.skipType(tag&7);break;}}
return message;};History.decodeDelimited=function decodeDelimited(reader){if(!(reader instanceof $Reader))
reader=new $Reader(reader);return this.decode(reader,reader.uint32());};History.verify=function verify(message){if(typeof message!=="object"||message===null)
return "object expected";if(message.Proto!=null&&message.hasOwnProperty("Proto"))
switch(message.Proto){default:return "Proto: enum value expected";case 0:case 1:case 2:case 3:case 4:case 5:break;}
if(message.State!=null&&message.hasOwnProperty("State"))
switch(message.State){default:return "State: enum value expected";case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 9:case 10:case 11:case 12:case 13:case 14:case 15:case 16:case 17:case 18:case 19:case 20:break;}
if(message.OpponentId!=null&&message.hasOwnProperty("OpponentId"))
if(!$util.isString(message.OpponentId))
return "OpponentId: string expected";if(message.NextMsgId!=null&&message.hasOwnProperty("NextMsgId"))
if(!$util.isInteger(message.NextMsgId))
return "NextMsgId: integer expected";if(message.Messages!=null&&message.hasOwnProperty("Messages")){if(!Array.isArray(message.Messages))
return "Messages: array expected";for(var i=0;i<message.Messages.length;++i){var error=$root.protos.Message.verify(message.Messages[i]);if(error)
return "Messages."+error;}}
return null;};History.fromObject=function fromObject(object){if(object instanceof $root.protos.History)
return object;var message=new $root.protos.History();switch(object.Proto){case "_BASE":case 0:message.Proto=0;break;case "_CLIENT_INIT":case 1:message.Proto=1;break;case "_MESSAGE":case 2:message.Proto=2;break;case "_PING":case 3:message.Proto=3;break;case "_REPORT":case 4:message.Proto=4;break;case "_SERVER_STATE_CHANGE":case 5:message.Proto=5;break;}
switch(object.State){case "FAIL":case 0:message.State=0;break;case "INIT":case 1:message.State=1;break;case "LOOKING_FOR_OPPONENT":case 2:message.State=2;break;case "CHAT_IN_PROGRESS":case 3:message.State=3;break;case "IDLE":case 4:message.State=4;break;case "MESSAGE":case 5:message.State=5;break;case "LOOK_FOR_NEXT_CHAT":case 6:message.State=6;break;case "STRANGER_HAS_LEFT":case 7:message.State=7;break;case "QUIT":case 8:message.State=8;break;case "STRANGER_DISCONNECTED":case 9:message.State=9;break;case "CHAT_RESTORED":case 10:message.State=10;break;case "REFRESH_UI":case 11:message.State=11;break;case "PING":case 12:message.State=12;break;case "PONG":case 13:message.State=13;break;case "USER_IS_TYPING":case 14:message.State=14;break;case "USER_NOT_TYPING":case 15:message.State=15;break;case "REPORT":case 16:message.State=16;break;case "RESTORE_BY_CHAT_CODE":case 17:message.State=17;break;case "CMD_TRANSFER_HISTORY":case 18:message.State=18;break;case "DIALOG_HISTORY":case 19:message.State=19;break;case "DISCONNECT":case 20:message.State=20;break;}
if(object.OpponentId!=null)
message.OpponentId=String(object.OpponentId);if(object.NextMsgId!=null)
message.NextMsgId=object.NextMsgId>>>0;if(object.Messages){if(!Array.isArray(object.Messages))
throw TypeError(".protos.History.Messages: array expected");message.Messages=[];for(var i=0;i<object.Messages.length;++i){if(typeof object.Messages[i]!=="object")
throw TypeError(".protos.History.Messages: object expected");message.Messages[i]=$root.protos.Message.fromObject(object.Messages[i]);}}
return message;};History.toObject=function toObject(message,options){if(!options)
options={};var object={};if(options.arrays||options.defaults)
object.Messages=[];if(options.defaults){object.Proto=options.enums===String?"_BASE":0;object.State=options.enums===String?"FAIL":0;object.OpponentId="";object.NextMsgId=0;}
if(message.Proto!=null&&message.hasOwnProperty("Proto"))
object.Proto=options.enums===String?$root.protos.PROTO[message.Proto]:message.Proto;if(message.State!=null&&message.hasOwnProperty("State"))
object.State=options.enums===String?$root.protos.STATE[message.State]:message.State;if(message.OpponentId!=null&&message.hasOwnProperty("OpponentId"))
object.OpponentId=message.OpponentId;if(message.NextMsgId!=null&&message.hasOwnProperty("NextMsgId"))
object.NextMsgId=message.NextMsgId;if(message.Messages&&message.Messages.length){object.Messages=[];for(var j=0;j<message.Messages.length;++j)
object.Messages[j]=$root.protos.Message.toObject(message.Messages[j],options);}
return object;};History.prototype.toJSON=function toJSON(){return this.constructor.toObject(this,$protobuf.util.toJSONOptions);};return History;})();protos.Message=(function(){function Message(properties){this.replyTo=[];if(properties)
for(var keys=Object.keys(properties),i=0;i<keys.length;++i)
if(properties[keys[i]]!=null)
this[keys[i]]=properties[keys[i]];}
Message.prototype.Proto=0;Message.prototype.State=0;Message.prototype.Id=0;Message.prototype.Type=0;Message.prototype.Body="";Message.prototype.Outgoing=false;Message.prototype.timeLimit=0;Message.prototype.replyTo=$util.emptyArray;Message.create=function create(properties){return new Message(properties);};Message.encode=function encode(message,writer){if(!writer)
writer=$Writer.create();if(message.Proto!=null&&message.hasOwnProperty("Proto"))
writer.uint32(8).int32(message.Proto);if(message.State!=null&&message.hasOwnProperty("State"))
writer.uint32(16).int32(message.State);if(message.Id!=null&&message.hasOwnProperty("Id"))
writer.uint32(24).uint32(message.Id);if(message.Type!=null&&message.hasOwnProperty("Type"))
writer.uint32(32).int32(message.Type);if(message.Body!=null&&message.hasOwnProperty("Body"))
writer.uint32(42).string(message.Body);if(message.Outgoing!=null&&message.hasOwnProperty("Outgoing"))
writer.uint32(48).bool(message.Outgoing);if(message.timeLimit!=null&&message.hasOwnProperty("timeLimit"))
writer.uint32(56).uint32(message.timeLimit);if(message.replyTo!=null&&message.replyTo.length){writer.uint32(66).fork();for(var i=0;i<message.replyTo.length;++i)
writer.uint32(message.replyTo[i]);writer.ldelim();}
return writer;};Message.encodeDelimited=function encodeDelimited(message,writer){return this.encode(message,writer).ldelim();};Message.decode=function decode(reader,length){if(!(reader instanceof $Reader))
reader=$Reader.create(reader);var end=length===undefined?reader.len:reader.pos+length,message=new $root.protos.Message();while(reader.pos<end){var tag=reader.uint32();switch(tag>>>3){case 1:message.Proto=reader.int32();break;case 2:message.State=reader.int32();break;case 3:message.Id=reader.uint32();break;case 4:message.Type=reader.int32();break;case 5:message.Body=reader.string();break;case 6:message.Outgoing=reader.bool();break;case 7:message.timeLimit=reader.uint32();break;case 8:if(!(message.replyTo&&message.replyTo.length))
message.replyTo=[];if((tag&7)===2){var end2=reader.uint32()+reader.pos;while(reader.pos<end2)
message.replyTo.push(reader.uint32());}else
message.replyTo.push(reader.uint32());break;default:reader.skipType(tag&7);break;}}
return message;};Message.decodeDelimited=function decodeDelimited(reader){if(!(reader instanceof $Reader))
reader=new $Reader(reader);return this.decode(reader,reader.uint32());};Message.verify=function verify(message){if(typeof message!=="object"||message===null)
return "object expected";if(message.Proto!=null&&message.hasOwnProperty("Proto"))
switch(message.Proto){default:return "Proto: enum value expected";case 0:case 1:case 2:case 3:case 4:case 5:break;}
if(message.State!=null&&message.hasOwnProperty("State"))
switch(message.State){default:return "State: enum value expected";case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 9:case 10:case 11:case 12:case 13:case 14:case 15:case 16:case 17:case 18:case 19:case 20:break;}
if(message.Id!=null&&message.hasOwnProperty("Id"))
if(!$util.isInteger(message.Id))
return "Id: integer expected";if(message.Type!=null&&message.hasOwnProperty("Type"))
switch(message.Type){default:return "Type: enum value expected";case 0:case 1:case 2:case 3:break;}
if(message.Body!=null&&message.hasOwnProperty("Body"))
if(!$util.isString(message.Body))
return "Body: string expected";if(message.Outgoing!=null&&message.hasOwnProperty("Outgoing"))
if(typeof message.Outgoing!=="boolean")
return "Outgoing: boolean expected";if(message.timeLimit!=null&&message.hasOwnProperty("timeLimit"))
if(!$util.isInteger(message.timeLimit))
return "timeLimit: integer expected";if(message.replyTo!=null&&message.hasOwnProperty("replyTo")){if(!Array.isArray(message.replyTo))
return "replyTo: array expected";for(var i=0;i<message.replyTo.length;++i)
if(!$util.isInteger(message.replyTo[i]))
return "replyTo: integer[] expected";}
return null;};Message.fromObject=function fromObject(object){if(object instanceof $root.protos.Message)
return object;var message=new $root.protos.Message();switch(object.Proto){case "_BASE":case 0:message.Proto=0;break;case "_CLIENT_INIT":case 1:message.Proto=1;break;case "_MESSAGE":case 2:message.Proto=2;break;case "_PING":case 3:message.Proto=3;break;case "_REPORT":case 4:message.Proto=4;break;case "_SERVER_STATE_CHANGE":case 5:message.Proto=5;break;}
switch(object.State){case "FAIL":case 0:message.State=0;break;case "INIT":case 1:message.State=1;break;case "LOOKING_FOR_OPPONENT":case 2:message.State=2;break;case "CHAT_IN_PROGRESS":case 3:message.State=3;break;case "IDLE":case 4:message.State=4;break;case "MESSAGE":case 5:message.State=5;break;case "LOOK_FOR_NEXT_CHAT":case 6:message.State=6;break;case "STRANGER_HAS_LEFT":case 7:message.State=7;break;case "QUIT":case 8:message.State=8;break;case "STRANGER_DISCONNECTED":case 9:message.State=9;break;case "CHAT_RESTORED":case 10:message.State=10;break;case "REFRESH_UI":case 11:message.State=11;break;case "PING":case 12:message.State=12;break;case "PONG":case 13:message.State=13;break;case "USER_IS_TYPING":case 14:message.State=14;break;case "USER_NOT_TYPING":case 15:message.State=15;break;case "REPORT":case 16:message.State=16;break;case "RESTORE_BY_CHAT_CODE":case 17:message.State=17;break;case "CMD_TRANSFER_HISTORY":case 18:message.State=18;break;case "DIALOG_HISTORY":case 19:message.State=19;break;case "DISCONNECT":case 20:message.State=20;break;}
if(object.Id!=null)
message.Id=object.Id>>>0;switch(object.Type){case "_":case 0:message.Type=0;break;case "SYSTEM":case 1:message.Type=1;break;case "TEXT":case 2:message.Type=2;break;case "PHOTO":case 3:message.Type=3;break;}
if(object.Body!=null)
message.Body=String(object.Body);if(object.Outgoing!=null)
message.Outgoing=Boolean(object.Outgoing);if(object.timeLimit!=null)
message.timeLimit=object.timeLimit>>>0;if(object.replyTo){if(!Array.isArray(object.replyTo))
throw TypeError(".protos.Message.replyTo: array expected");message.replyTo=[];for(var i=0;i<object.replyTo.length;++i)
message.replyTo[i]=object.replyTo[i]>>>0;}
return message;};Message.toObject=function toObject(message,options){if(!options)
options={};var object={};if(options.arrays||options.defaults)
object.replyTo=[];if(options.defaults){object.Proto=options.enums===String?"_BASE":0;object.State=options.enums===String?"FAIL":0;object.Id=0;object.Type=options.enums===String?"_":0;object.Body="";object.Outgoing=false;object.timeLimit=0;}
if(message.Proto!=null&&message.hasOwnProperty("Proto"))
object.Proto=options.enums===String?$root.protos.PROTO[message.Proto]:message.Proto;if(message.State!=null&&message.hasOwnProperty("State"))
object.State=options.enums===String?$root.protos.STATE[message.State]:message.State;if(message.Id!=null&&message.hasOwnProperty("Id"))
object.Id=message.Id;if(message.Type!=null&&message.hasOwnProperty("Type"))
object.Type=options.enums===String?$root.protos.Message.TYPE[message.Type]:message.Type;if(message.Body!=null&&message.hasOwnProperty("Body"))
object.Body=message.Body;if(message.Outgoing!=null&&message.hasOwnProperty("Outgoing"))
object.Outgoing=message.Outgoing;if(message.timeLimit!=null&&message.hasOwnProperty("timeLimit"))
object.timeLimit=message.timeLimit;if(message.replyTo&&message.replyTo.length){object.replyTo=[];for(var j=0;j<message.replyTo.length;++j)
object.replyTo[j]=message.replyTo[j];}
return object;};Message.prototype.toJSON=function toJSON(){return this.constructor.toObject(this,$protobuf.util.toJSONOptions);};Message.TYPE=(function(){var valuesById={},values=Object.create(valuesById);values[valuesById[0]="_"]=0;values[valuesById[1]="SYSTEM"]=1;values[valuesById[2]="TEXT"]=2;values[valuesById[3]="PHOTO"]=3;return values;})();return Message;})();protos.Ping=(function(){function Ping(properties){if(properties)
for(var keys=Object.keys(properties),i=0;i<keys.length;++i)
if(properties[keys[i]]!=null)
this[keys[i]]=properties[keys[i]];}
Ping.create=function create(properties){return new Ping(properties);};Ping.encode=function encode(message,writer){if(!writer)
writer=$Writer.create();return writer;};Ping.encodeDelimited=function encodeDelimited(message,writer){return this.encode(message,writer).ldelim();};Ping.decode=function decode(reader,length){if(!(reader instanceof $Reader))
reader=$Reader.create(reader);var end=length===undefined?reader.len:reader.pos+length,message=new $root.protos.Ping();while(reader.pos<end){var tag=reader.uint32();switch(tag>>>3){default:reader.skipType(tag&7);break;}}
return message;};Ping.decodeDelimited=function decodeDelimited(reader){if(!(reader instanceof $Reader))
reader=new $Reader(reader);return this.decode(reader,reader.uint32());};Ping.verify=function verify(message){if(typeof message!=="object"||message===null)
return "object expected";return null;};Ping.fromObject=function fromObject(object){if(object instanceof $root.protos.Ping)
return object;return new $root.protos.Ping();};Ping.toObject=function toObject(){return{};};Ping.prototype.toJSON=function toJSON(){return this.constructor.toObject(this,$protobuf.util.toJSONOptions);};return Ping;})();protos.Report=(function(){function Report(properties){this.Messages=[];if(properties)
for(var keys=Object.keys(properties),i=0;i<keys.length;++i)
if(properties[keys[i]]!=null)
this[keys[i]]=properties[keys[i]];}
Report.prototype.Proto=0;Report.prototype.State=0;Report.prototype.OpponentID="";Report.prototype.Reason=0;Report.prototype.Desc="";Report.prototype.Blacklist=false;Report.prototype.NextMsgId=0;Report.prototype.Messages=$util.emptyArray;Report.create=function create(properties){return new Report(properties);};Report.encode=function encode(message,writer){if(!writer)
writer=$Writer.create();if(message.Proto!=null&&message.hasOwnProperty("Proto"))
writer.uint32(8).int32(message.Proto);if(message.State!=null&&message.hasOwnProperty("State"))
writer.uint32(16).int32(message.State);if(message.OpponentID!=null&&message.hasOwnProperty("OpponentID"))
writer.uint32(26).string(message.OpponentID);if(message.Reason!=null&&message.hasOwnProperty("Reason"))
writer.uint32(32).int32(message.Reason);if(message.Desc!=null&&message.hasOwnProperty("Desc"))
writer.uint32(42).string(message.Desc);if(message.Blacklist!=null&&message.hasOwnProperty("Blacklist"))
writer.uint32(48).bool(message.Blacklist);if(message.NextMsgId!=null&&message.hasOwnProperty("NextMsgId"))
writer.uint32(56).uint32(message.NextMsgId);if(message.Messages!=null&&message.Messages.length)
for(var i=0;i<message.Messages.length;++i)
$root.protos.Message.encode(message.Messages[i],writer.uint32(66).fork()).ldelim();return writer;};Report.encodeDelimited=function encodeDelimited(message,writer){return this.encode(message,writer).ldelim();};Report.decode=function decode(reader,length){if(!(reader instanceof $Reader))
reader=$Reader.create(reader);var end=length===undefined?reader.len:reader.pos+length,message=new $root.protos.Report();while(reader.pos<end){var tag=reader.uint32();switch(tag>>>3){case 1:message.Proto=reader.int32();break;case 2:message.State=reader.int32();break;case 3:message.OpponentID=reader.string();break;case 4:message.Reason=reader.int32();break;case 5:message.Desc=reader.string();break;case 6:message.Blacklist=reader.bool();break;case 7:message.NextMsgId=reader.uint32();break;case 8:if(!(message.Messages&&message.Messages.length))
message.Messages=[];message.Messages.push($root.protos.Message.decode(reader,reader.uint32()));break;default:reader.skipType(tag&7);break;}}
return message;};Report.decodeDelimited=function decodeDelimited(reader){if(!(reader instanceof $Reader))
reader=new $Reader(reader);return this.decode(reader,reader.uint32());};Report.verify=function verify(message){if(typeof message!=="object"||message===null)
return "object expected";if(message.Proto!=null&&message.hasOwnProperty("Proto"))
switch(message.Proto){default:return "Proto: enum value expected";case 0:case 1:case 2:case 3:case 4:case 5:break;}
if(message.State!=null&&message.hasOwnProperty("State"))
switch(message.State){default:return "State: enum value expected";case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 9:case 10:case 11:case 12:case 13:case 14:case 15:case 16:case 17:case 18:case 19:case 20:break;}
if(message.OpponentID!=null&&message.hasOwnProperty("OpponentID"))
if(!$util.isString(message.OpponentID))
return "OpponentID: string expected";if(message.Reason!=null&&message.hasOwnProperty("Reason"))
switch(message.Reason){default:return "Reason: enum value expected";case 0:case 1:case 2:case 3:case 4:case 5:break;}
if(message.Desc!=null&&message.hasOwnProperty("Desc"))
if(!$util.isString(message.Desc))
return "Desc: string expected";if(message.Blacklist!=null&&message.hasOwnProperty("Blacklist"))
if(typeof message.Blacklist!=="boolean")
return "Blacklist: boolean expected";if(message.NextMsgId!=null&&message.hasOwnProperty("NextMsgId"))
if(!$util.isInteger(message.NextMsgId))
return "NextMsgId: integer expected";if(message.Messages!=null&&message.hasOwnProperty("Messages")){if(!Array.isArray(message.Messages))
return "Messages: array expected";for(var i=0;i<message.Messages.length;++i){var error=$root.protos.Message.verify(message.Messages[i]);if(error)
return "Messages."+error;}}
return null;};Report.fromObject=function fromObject(object){if(object instanceof $root.protos.Report)
return object;var message=new $root.protos.Report();switch(object.Proto){case "_BASE":case 0:message.Proto=0;break;case "_CLIENT_INIT":case 1:message.Proto=1;break;case "_MESSAGE":case 2:message.Proto=2;break;case "_PING":case 3:message.Proto=3;break;case "_REPORT":case 4:message.Proto=4;break;case "_SERVER_STATE_CHANGE":case 5:message.Proto=5;break;}
switch(object.State){case "FAIL":case 0:message.State=0;break;case "INIT":case 1:message.State=1;break;case "LOOKING_FOR_OPPONENT":case 2:message.State=2;break;case "CHAT_IN_PROGRESS":case 3:message.State=3;break;case "IDLE":case 4:message.State=4;break;case "MESSAGE":case 5:message.State=5;break;case "LOOK_FOR_NEXT_CHAT":case 6:message.State=6;break;case "STRANGER_HAS_LEFT":case 7:message.State=7;break;case "QUIT":case 8:message.State=8;break;case "STRANGER_DISCONNECTED":case 9:message.State=9;break;case "CHAT_RESTORED":case 10:message.State=10;break;case "REFRESH_UI":case 11:message.State=11;break;case "PING":case 12:message.State=12;break;case "PONG":case 13:message.State=13;break;case "USER_IS_TYPING":case 14:message.State=14;break;case "USER_NOT_TYPING":case 15:message.State=15;break;case "REPORT":case 16:message.State=16;break;case "RESTORE_BY_CHAT_CODE":case 17:message.State=17;break;case "CMD_TRANSFER_HISTORY":case 18:message.State=18;break;case "DIALOG_HISTORY":case 19:message.State=19;break;case "DISCONNECT":case 20:message.State=20;break;}
if(object.OpponentID!=null)
message.OpponentID=String(object.OpponentID);switch(object.Reason){case "UNDEFINED_REASON":case 0:message.Reason=0;break;case "SPAM":case 1:message.Reason=1;break;case "INAPPROPRIATE_CONTENT":case 2:message.Reason=2;break;case "ILLIGAL_CONTENT":case 3:message.Reason=3;break;case "ABUSIVE_BEHAVIOUR":case 4:message.Reason=4;break;case "OTHER":case 5:message.Reason=5;break;}
if(object.Desc!=null)
message.Desc=String(object.Desc);if(object.Blacklist!=null)
message.Blacklist=Boolean(object.Blacklist);if(object.NextMsgId!=null)
message.NextMsgId=object.NextMsgId>>>0;if(object.Messages){if(!Array.isArray(object.Messages))
throw TypeError(".protos.Report.Messages: array expected");message.Messages=[];for(var i=0;i<object.Messages.length;++i){if(typeof object.Messages[i]!=="object")
throw TypeError(".protos.Report.Messages: object expected");message.Messages[i]=$root.protos.Message.fromObject(object.Messages[i]);}}
return message;};Report.toObject=function toObject(message,options){if(!options)
options={};var object={};if(options.arrays||options.defaults)
object.Messages=[];if(options.defaults){object.Proto=options.enums===String?"_BASE":0;object.State=options.enums===String?"FAIL":0;object.OpponentID="";object.Reason=options.enums===String?"UNDEFINED_REASON":0;object.Desc="";object.Blacklist=false;object.NextMsgId=0;}
if(message.Proto!=null&&message.hasOwnProperty("Proto"))
object.Proto=options.enums===String?$root.protos.PROTO[message.Proto]:message.Proto;if(message.State!=null&&message.hasOwnProperty("State"))
object.State=options.enums===String?$root.protos.STATE[message.State]:message.State;if(message.OpponentID!=null&&message.hasOwnProperty("OpponentID"))
object.OpponentID=message.OpponentID;if(message.Reason!=null&&message.hasOwnProperty("Reason"))
object.Reason=options.enums===String?$root.protos.Report.REASON[message.Reason]:message.Reason;if(message.Desc!=null&&message.hasOwnProperty("Desc"))
object.Desc=message.Desc;if(message.Blacklist!=null&&message.hasOwnProperty("Blacklist"))
object.Blacklist=message.Blacklist;if(message.NextMsgId!=null&&message.hasOwnProperty("NextMsgId"))
object.NextMsgId=message.NextMsgId;if(message.Messages&&message.Messages.length){object.Messages=[];for(var j=0;j<message.Messages.length;++j)
object.Messages[j]=$root.protos.Message.toObject(message.Messages[j],options);}
return object;};Report.prototype.toJSON=function toJSON(){return this.constructor.toObject(this,$protobuf.util.toJSONOptions);};Report.REASON=(function(){var valuesById={},values=Object.create(valuesById);values[valuesById[0]="UNDEFINED_REASON"]=0;values[valuesById[1]="SPAM"]=1;values[valuesById[2]="INAPPROPRIATE_CONTENT"]=2;values[valuesById[3]="ILLIGAL_CONTENT"]=3;values[valuesById[4]="ABUSIVE_BEHAVIOUR"]=4;values[valuesById[5]="OTHER"]=5;return values;})();return Report;})();protos.ServerStateChange=(function(){function ServerStateChange(properties){if(properties)
for(var keys=Object.keys(properties),i=0;i<keys.length;++i)
if(properties[keys[i]]!=null)
this[keys[i]]=properties[keys[i]];}
ServerStateChange.prototype.Proto=0;ServerStateChange.prototype.State=0;ServerStateChange.prototype.SessionId="";ServerStateChange.prototype.SessionSecret="";ServerStateChange.prototype.OpponentId="";ServerStateChange.prototype.OpponentName="";ServerStateChange.prototype.MsgStartId=0;ServerStateChange.prototype.ChatCode="";ServerStateChange.create=function create(properties){return new ServerStateChange(properties);};ServerStateChange.encode=function encode(message,writer){if(!writer)
writer=$Writer.create();if(message.Proto!=null&&message.hasOwnProperty("Proto"))
writer.uint32(8).int32(message.Proto);if(message.State!=null&&message.hasOwnProperty("State"))
writer.uint32(16).int32(message.State);if(message.SessionId!=null&&message.hasOwnProperty("SessionId"))
writer.uint32(26).string(message.SessionId);if(message.SessionSecret!=null&&message.hasOwnProperty("SessionSecret"))
writer.uint32(34).string(message.SessionSecret);if(message.OpponentId!=null&&message.hasOwnProperty("OpponentId"))
writer.uint32(42).string(message.OpponentId);if(message.OpponentName!=null&&message.hasOwnProperty("OpponentName"))
writer.uint32(50).string(message.OpponentName);if(message.MsgStartId!=null&&message.hasOwnProperty("MsgStartId"))
writer.uint32(56).uint32(message.MsgStartId);if(message.ChatCode!=null&&message.hasOwnProperty("ChatCode"))
writer.uint32(66).string(message.ChatCode);return writer;};ServerStateChange.encodeDelimited=function encodeDelimited(message,writer){return this.encode(message,writer).ldelim();};ServerStateChange.decode=function decode(reader,length){if(!(reader instanceof $Reader))
reader=$Reader.create(reader);var end=length===undefined?reader.len:reader.pos+length,message=new $root.protos.ServerStateChange();while(reader.pos<end){var tag=reader.uint32();switch(tag>>>3){case 1:message.Proto=reader.int32();break;case 2:message.State=reader.int32();break;case 3:message.SessionId=reader.string();break;case 4:message.SessionSecret=reader.string();break;case 5:message.OpponentId=reader.string();break;case 6:message.OpponentName=reader.string();break;case 7:message.MsgStartId=reader.uint32();break;case 8:message.ChatCode=reader.string();break;default:reader.skipType(tag&7);break;}}
return message;};ServerStateChange.decodeDelimited=function decodeDelimited(reader){if(!(reader instanceof $Reader))
reader=new $Reader(reader);return this.decode(reader,reader.uint32());};ServerStateChange.verify=function verify(message){if(typeof message!=="object"||message===null)
return "object expected";if(message.Proto!=null&&message.hasOwnProperty("Proto"))
switch(message.Proto){default:return "Proto: enum value expected";case 0:case 1:case 2:case 3:case 4:case 5:break;}
if(message.State!=null&&message.hasOwnProperty("State"))
switch(message.State){default:return "State: enum value expected";case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 9:case 10:case 11:case 12:case 13:case 14:case 15:case 16:case 17:case 18:case 19:case 20:break;}
if(message.SessionId!=null&&message.hasOwnProperty("SessionId"))
if(!$util.isString(message.SessionId))
return "SessionId: string expected";if(message.SessionSecret!=null&&message.hasOwnProperty("SessionSecret"))
if(!$util.isString(message.SessionSecret))
return "SessionSecret: string expected";if(message.OpponentId!=null&&message.hasOwnProperty("OpponentId"))
if(!$util.isString(message.OpponentId))
return "OpponentId: string expected";if(message.OpponentName!=null&&message.hasOwnProperty("OpponentName"))
if(!$util.isString(message.OpponentName))
return "OpponentName: string expected";if(message.MsgStartId!=null&&message.hasOwnProperty("MsgStartId"))
if(!$util.isInteger(message.MsgStartId))
return "MsgStartId: integer expected";if(message.ChatCode!=null&&message.hasOwnProperty("ChatCode"))
if(!$util.isString(message.ChatCode))
return "ChatCode: string expected";return null;};ServerStateChange.fromObject=function fromObject(object){if(object instanceof $root.protos.ServerStateChange)
return object;var message=new $root.protos.ServerStateChange();switch(object.Proto){case "_BASE":case 0:message.Proto=0;break;case "_CLIENT_INIT":case 1:message.Proto=1;break;case "_MESSAGE":case 2:message.Proto=2;break;case "_PING":case 3:message.Proto=3;break;case "_REPORT":case 4:message.Proto=4;break;case "_SERVER_STATE_CHANGE":case 5:message.Proto=5;break;}
switch(object.State){case "FAIL":case 0:message.State=0;break;case "INIT":case 1:message.State=1;break;case "LOOKING_FOR_OPPONENT":case 2:message.State=2;break;case "CHAT_IN_PROGRESS":case 3:message.State=3;break;case "IDLE":case 4:message.State=4;break;case "MESSAGE":case 5:message.State=5;break;case "LOOK_FOR_NEXT_CHAT":case 6:message.State=6;break;case "STRANGER_HAS_LEFT":case 7:message.State=7;break;case "QUIT":case 8:message.State=8;break;case "STRANGER_DISCONNECTED":case 9:message.State=9;break;case "CHAT_RESTORED":case 10:message.State=10;break;case "REFRESH_UI":case 11:message.State=11;break;case "PING":case 12:message.State=12;break;case "PONG":case 13:message.State=13;break;case "USER_IS_TYPING":case 14:message.State=14;break;case "USER_NOT_TYPING":case 15:message.State=15;break;case "REPORT":case 16:message.State=16;break;case "RESTORE_BY_CHAT_CODE":case 17:message.State=17;break;case "CMD_TRANSFER_HISTORY":case 18:message.State=18;break;case "DIALOG_HISTORY":case 19:message.State=19;break;case "DISCONNECT":case 20:message.State=20;break;}
if(object.SessionId!=null)
message.SessionId=String(object.SessionId);if(object.SessionSecret!=null)
message.SessionSecret=String(object.SessionSecret);if(object.OpponentId!=null)
message.OpponentId=String(object.OpponentId);if(object.OpponentName!=null)
message.OpponentName=String(object.OpponentName);if(object.MsgStartId!=null)
message.MsgStartId=object.MsgStartId>>>0;if(object.ChatCode!=null)
message.ChatCode=String(object.ChatCode);return message;};ServerStateChange.toObject=function toObject(message,options){if(!options)
options={};var object={};if(options.defaults){object.Proto=options.enums===String?"_BASE":0;object.State=options.enums===String?"FAIL":0;object.SessionId="";object.SessionSecret="";object.OpponentId="";object.OpponentName="";object.MsgStartId=0;object.ChatCode="";}
if(message.Proto!=null&&message.hasOwnProperty("Proto"))
object.Proto=options.enums===String?$root.protos.PROTO[message.Proto]:message.Proto;if(message.State!=null&&message.hasOwnProperty("State"))
object.State=options.enums===String?$root.protos.STATE[message.State]:message.State;if(message.SessionId!=null&&message.hasOwnProperty("SessionId"))
object.SessionId=message.SessionId;if(message.SessionSecret!=null&&message.hasOwnProperty("SessionSecret"))
object.SessionSecret=message.SessionSecret;if(message.OpponentId!=null&&message.hasOwnProperty("OpponentId"))
object.OpponentId=message.OpponentId;if(message.OpponentName!=null&&message.hasOwnProperty("OpponentName"))
object.OpponentName=message.OpponentName;if(message.MsgStartId!=null&&message.hasOwnProperty("MsgStartId"))
object.MsgStartId=message.MsgStartId;if(message.ChatCode!=null&&message.hasOwnProperty("ChatCode"))
object.ChatCode=message.ChatCode;return object;};ServerStateChange.prototype.toJSON=function toJSON(){return this.constructor.toObject(this,$protobuf.util.toJSONOptions);};return ServerStateChange;})();return protos;})();return $root;});function dbStorageWrapper(table_name){return new function(table_name){this.put=function(entry){return new Promise(function(success,fail){DB.getDB(function(db){var tx=db.transaction(table_name,'readwrite');var store=tx.objectStore(table_name);var req=store.put(entry);req.onsuccess=success;req.onerror=function(ev){fail();};});});};this.add=function(entry){return new Promise(function(success,fail){DB.getDB(function(db){var tx=db.transaction(table_name,'readwrite');var store=tx.objectStore(table_name);var req=store.add(entry);req.onsuccess=function(ev){success(ev.target.result);};req.onerror=function(ev){fail();};});});};this.getAll=function(){return new Promise(function(success,fail){DB.getDB(function(db){var tx=db.transaction(table_name);var store=tx.objectStore(table_name);var req=store.getAll();req.onsuccess=function(ev){var result=ev.target.result;if(typeof(result)==='undefined'){fail();}
success(result);};req.onerror=function(ev){fail(ev);};})});};this.get=function(key){return new Promise(function(success,fail){DB.getDB(function(db){var tx=db.transaction(table_name);var store=tx.objectStore(table_name);var req=store.get(key);req.onsuccess=function(ev){var result=ev.target.result;if(typeof(result)==='undefined'){fail();}
success(result);};req.onerror=function(ev){fail(ev);};});});};this.getByIndex=function(index_name,index_value){return new Promise(function(success,fail){if(!DB.stores[table_name].indexes||!DB.stores[table_name].indexes[index_name]){fail();return;}
DB.getDB(function(db){var tx=db.transaction(table_name);var store=tx.objectStore(table_name);var index=store.index(index_name);var req=index.getAll(index_value);req.onsuccess=function(ev){var result=ev.target.result;if(typeof(result)==='undefined'){fail();}
success(result);};req.onerror=function(ev){fail(ev);};});});};this.delete=function(key_value){return new Promise(function(success,fail){DB.getDB(function(db){var tx=db.transaction(table_name,'readwrite');var store=tx.objectStore(table_name);var req=store.delete(key_value);req.onsuccess=function(ev){var result=ev.target.result;if(typeof(result)==='undefined'){fail();}
success(result);};req.onerror=function(ev){fail(ev);};});});};}(table_name);}
DB={DB_NAME:'chat42',DB_VERSION:2,stores:{dialogs:{store:['dialogs',{keyPath:"_id",autoIncrement:true}],indexes:{saved:["saved","saved",{unique:false}],}},messages:{store:['messages',{keyPath:"_id",autoIncrement:true}],indexes:{dialog_id:["dialog_id","dialog_id",{unique:false}],}},},dialogs:dbStorageWrapper('dialogs'),messages:dbStorageWrapper('messages'),_db:null,init:function(){if(DB._db!==null)return;window.indexedDB=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB;window.IDBTransaction=window.IDBTransaction||window.webkitIDBTransaction||window.msIDBTransaction||{READ_WRITE:"readwrite"};window.IDBKeyRange=window.IDBKeyRange||window.webkitIDBKeyRange||window.msIDBKeyRange;if(!window.indexedDB){return;}
DB._db=new Promise(function(success,error){var request=window.indexedDB.open(DB.DB_NAME,DB.DB_VERSION);request.onerror=function(event){error(new Error("Database error: "+event.target.errorCode))};request.onsuccess=function(event){success(event.target.result);};request.onupgradeneeded=function(event){var db=event.target.result;db.onerror=function(event){};if(event.oldVersion<DB.DB_VERSION){if(event.oldVersion===1){db.deleteObjectStore('conversations');}}
for(var key in DB.stores){if(!DB.stores.hasOwnProperty(key))continue;var create_params=DB.stores[key].store;var store=db.createObjectStore.apply(db,create_params);if(DB.stores[key].indexes){for(var key1 in DB.stores[key].indexes){if(!DB.stores[key].indexes.hasOwnProperty(key1))continue;var create_params=DB.stores[key].indexes[key1];store.createIndex.apply(store,create_params);}}}};}).then(function(db){DB._db=db;DB._db.onerror=function(event){};}).catch(function(err){});},getDB:function(callback){if(isPromise(DB._db)){DB._db.then(function(){callback(DB._db);});}else{callback(DB._db);}}};DB.init();Observer={listeners:{},listeners_global:[],addListener:function(callback){var events=Array.prototype.slice.call(arguments,1);if(events.length<1){this.listeners_global.push(callback);}else for(var key in events){if(!events.hasOwnProperty(key))continue;var event=events[key];if(!this.listeners[event]){this.listeners[event]=[callback];}else{this.listeners[event].push(callback);}}},delListener:function(callback){var events=Array.prototype.slice.call(arguments,1);if(events.length<1){for(var key in this.listeners_global){if(!this.listeners_global.hasOwnProperty(key))continue;if(this.listeners_global[key]===listener){this.listeners_global.splice(key,1);}}}else for(var i in events){if(!events.hasOwnProperty(i))continue;var event=events[i];if(!this.listeners[event])continue;for(var key in this.listeners[event]){if(!this.listeners[event].hasOwnProperty(key))continue;if(this.listeners[event][key]===callback){this.listeners[event].splice(key,1);}}}},fire:function(event){var args=Array.from(arguments);if(this.listeners[event]){for(var key in this.listeners[event]){if(!this.listeners[event].hasOwnProperty(key))continue;var callback=this.listeners[event][key];callback.apply(null,args);}}
if(this.listeners_global.length>0){for(var key in this.listeners_global){if(!this.listeners_global.hasOwnProperty(key))continue;var callback=this.listeners_global[key];callback.apply(null,args);}}}};State={webview:false,platform:0,PLATFORM_2_PROTO:{"desktop":protos.PLATFORM.WEB,"android":protos.PLATFORM.ANDROID,"ios":protos.PLATFORM.IOS},isWebview:function(){return State.webview;},setPlatform:function(platform){State.platform=State.PLATFORM_2_PROTO[platform]?State.PLATFORM_2_PROTO[platform]:protos.PLATFORM.WEB;},getPlatform:function(){return State.platform;},isIos:function(){return State.platform===protos.PLATFORM.IOS;},isAndroid:function(){return State.platform===protos.PLATFORM.ANDROID;},isAmazon:function(){if(!State.isAndroid())return false;if(typeof(Native)==='undefined')return false;if(Native.getAppBuild()<104)return false;return Native.getAppPackage().indexOf("android.amazon")>0;}};Stat={chat_started:0,sec_in_chats:0,chats_count:0,msg_received:0,msg_sent:0,init:function(){Observer.addListener(save_scope(this,this.chat_state_changed),EVENT.CHAT_STATE_CHANGED);Observer.addListener(save_scope(this,this.events_messages),EVENT.MESSAGE_RECEIVED,EVENT.MESSAGE_SENT);},chat_state_changed:function(event,old_state,new_state){var now=(new Date()/1000|0);if(new_state===Chat.STATE.IN_PROGRESS){this.chat_started=now;this.chats_count++;}else if(old_state===Chat.STATE.IN_PROGRESS&&this.chat_started>0&&this.chats_count<now){var delta=now-this.chat_started;if(delta>0){this.sec_in_chats+=delta;}}},events_messages:function(event){if(event===EVENT.MESSAGE_RECEIVED){this.msg_received++;}else if(event===EVENT.MESSAGE_SENT){this.msg_sent++;}}};Clipboard={textarea:null,put:function(text){if(typeof(Native)!=='undefined'&&Native.putToClipboard){Native.putToClipboard(text);return;}
if(!Clipboard.textarea){Clipboard.textarea=document.createElement('textarea');Clipboard.textarea.setAttribute('readonly','');Clipboard.textarea.style.position='absolute';Clipboard.textarea.style.left='-9999px';}
Clipboard.textarea.value=text;document.body.appendChild(Clipboard.textarea);Clipboard.textarea.select();document.execCommand('copy');document.body.removeChild(Clipboard.textarea);}};Notifications={enabled:true,obj_btn:null,obj_snd_chat_started:null,obj_snd_message_received:null,sett_name:'sett_notifications_disabled',inited:false,init:function(){Notifications.obj_btn=document.getElementById('btn-notifications');Notifications.obj_btn.onclick=Notifications.toggleEnabled;Notifications.obj_snd_chat_started=document.getElementById('snd-chat-started');Notifications.obj_snd_message_received=document.getElementById('snd-msg-received');if(DataStorage.getLocal(Notifications.sett_name)!==null&&Notifications.enabled){Notifications.toggleEnabled();}
if(!Notifications.inited){Notifications.inited=true;Observer.addListener(Notifications.sendMessageReceived,EVENT.MESSAGE_RECEIVED);Observer.addListener(Notifications.sendChatStarted,EVENT.CHAT_STARTED,EVENT.CHAT_RESTORED);}},sendChatStarted:function(){if(!Notifications.enabled)return;Notifications.obj_snd_chat_started.pause();Notifications.obj_snd_chat_started.currentTime=0;Notifications.obj_snd_chat_started.play();},sendMessageReceived:function(){if(!Notifications.enabled)return;Notifications.obj_snd_message_received.pause();Notifications.obj_snd_message_received.currentTime=0;Notifications.obj_snd_message_received.play();},toggleEnabled:function(){if(Notifications.enabled){Notifications.obj_btn.classList.add('disabled');Notifications.obj_btn.classList.remove('enabled');Notifications.enabled=false;DataStorage.setLocal(Notifications.sett_name,1);}else{Notifications.obj_btn.classList.add('enabled');Notifications.obj_btn.classList.remove('disabled');Notifications.enabled=true;DataStorage.delLocal(Notifications.sett_name);}}};Camera={video:null,stream:null,init:function(){if(Camera.video!==null)return;Camera.video=document.querySelector('#camera-video');navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;},Start:function(){Camera.init();if(navigator.getUserMedia){navigator.getUserMedia({audio:false,video:{facingMode:"user"}},function(stream){Camera.stream=stream;try{Camera.video.srcObject=stream;}catch(error){Camera.video.src=window.URL.createObjectURL(stream);}
CameraUI.onCameraStarted();},Camera.on_error);}else{}},Stop:function(){if(!Camera.stream)return;Camera.stream.getTracks()[0].stop();Camera.stream=null;},on_error:function(e){CameraUI.onError(T.camera_failed_to_connect);},getSnapshot:function(max_width,max_height){if(!Camera.stream)return null;if(!max_width)max_width=1000;if(!max_height)max_height=1000;var canvas=document.createElement("canvas");var width=Camera.video.videoWidth;var height=Camera.video.videoHeight;if(width>height){if(width>max_width){height*=max_width/width;width=max_width;}}else{if(height>max_height){width*=max_height/height;height=max_height;}}
canvas.width=width;canvas.height=height;canvas.getContext('2d').drawImage(Camera.video,0,0,width,height);return canvas.toDataURL("image/jpeg",80);}};CameraUI={photo_uri:null,init:function(){document.getElementById('btn-camera').onclick=CameraUI.Start;document.getElementById('btn-camera-cancel').onclick=CameraUI.Stop;document.getElementById('btn-camera-send').onclick=CameraUI.Send;document.getElementById('btn-camera-err-close').onclick=CameraUI.Stop;document.querySelector('.camera-canvas .error').style.display='';document.getElementById('dialog-camera').addEventListener('posthide',UI.focusInput);var time_limit_obj=document.getElementById('camera-time-limit');var time_limit_text_obj=document.getElementById('camera-time-limit-text');time_limit_obj.getValueInSec=function(){var max_value=20;var value=(this.value*max_value/100+1)|0;return value>max_value||value<0?0:value;};time_limit_obj.oninput=function(){var value=time_limit_obj.getValueInSec();time_limit_text_obj.innerText=value>0?value+" "+T.camera_time_limit_sec:T.camera_time_limit_unlimited;};},Start:function(){document.querySelector('.camera-canvas .error').style.display='none';var time_limit_obj=document.getElementById('camera-time-limit');time_limit_obj.value=100;time_limit_obj.oninput.call(time_limit_obj);if(typeof(Native)!=='undefined'){document.getElementById('camera-canvas').style.display='';document.getElementById('camera-video').style.display='none';Native.startCamera(C.ph_max_width,C.ph_max_height,80);return;}
document.getElementById('camera-canvas').style.display='none';document.getElementById('camera-video').style.display='';document.getElementById('btn-camera-send').setAttribute('disabled',1);document.querySelector('.camera-canvas .loading').style.display='block';UI.showModal('dialog-camera');Camera.Start();},Stop:function(){document.getElementById('dialog-camera').hide();if(typeof(Native)==='undefined'){Camera.Stop();}},Send:function(){document.getElementById('dialog-camera').hide();var time_limit=document.getElementById('camera-time-limit').getValueInSec();if(CameraUI.photo_uri!==null){Chat.sendPhoto(CameraUI.photo_uri,time_limit);CameraUI.photo_uri=null;}else{Chat.sendPhoto(Camera.getSnapshot(C.ph_max_width,C.ph_max_height),time_limit);Camera.Stop();}},onError:function(err){document.getElementById('btn-camera-send').setAttribute('disabled',1);document.querySelector('.camera-canvas .error').style.display='block';document.querySelector('.camera-canvas .error .msg').innerHTML=err;},onCameraStarted:function(){document.getElementById('btn-camera-send').removeAttribute('disabled');document.querySelector('.camera-canvas .loading').style.display='none';},onPhotoTaken:function(uri){CameraUI.photo_uri=uri;var dialog_obj=document.getElementById('dialog-camera');var canvas=document.querySelector('#camera-canvas');dialog_obj.show();var img=new Image;img.onload=function(){var width=img.clientWidth>0?img.clientWidth:img.width;var height=img.clientHeight>0?img.clientHeight:img.height;var max_width=canvas.clientWidth;var free_height=document.body.clientHeight-dialog_obj.querySelector('.dialog-container').clientHeight;free_height=free_height>100?free_height-100:-100;var max_height=canvas.height+free_height;if(width>max_width){height*=max_width/width;width=max_width;}
if(height>max_height){width*=max_height/height;height=max_height;}
canvas.height=height|0;canvas.width=width|0;canvas.style.height=canvas.height+"px";canvas.style.width=canvas.width+"px";canvas.parentNode.style.height=canvas.style.height;canvas.getContext('2d').drawImage(img,0,0,width,height);UI.redraw();};img.src=uri;}};PhotoTimer={init:function(img_obj,timeout_sec){var timer_obj=Tpl('tpl-photo-timer',{value:timeout_sec});var node=img_obj.parentNode;node.appendChild(timer_obj);var interval=setInterval(function(){timeout_sec--;if(timeout_sec>0){timer_obj.innerText=timeout_sec;return;}
var text=Tpl('tpl-photo-expired-text');text.style.height=node.clientHeight+'px';text.style.width=node.clientWidth+'px';node.removeChild(img_obj);node.removeChild(timer_obj);node.appendChild(text);clearInterval(interval);},1000);}};Html={getElementHtml:function(element){var el=document.createElement('div');el.appendChild(element);return el.innerHTML;},createElement:function(html){var el=document.createElement('div');el.innerHTML=html;return el.childNodes[0];},process_array:function(nodes,callback,argument){if(!(nodes instanceof NodeList))return false;for(var i=0;i<nodes.length;i++){callback(nodes[i],argument);}
return true;},removeClass:function(el,class_name){if(Html.process_array(el,arguments.callee,class_name))return;if(!el)return;if(typeof(el.classList)!=='undefined'){el.classList.remove(class_name);return;}
var arr=el.className.split(' ');var result='';for(var i=0;i<arr.length;i++){var name=arr[i];if(name===class_name)continue;result+=' '+name;}
el.className=result.trim();},addClass:function(el,class_name){if(Html.process_array(el,arguments.callee,class_name))return;if(!el)return;if(typeof(el.classList)!=='undefined'){el.classList.add(class_name);return;}
var arr=el.className.split(' ');for(var i=0;i<arr.length;i++){var name=arr[i];if(name===class_name)return;}
el.className+=' '+class_name;},hasClass:function(el,class_name){if(!el)return false;if(typeof(el.classList)!=='undefined'){return el.classList.contains(class_name);}
var arr=el.className.split(' ');for(var i=0;i<arr.length;i++){var name=arr[i];if(name===class_name)return true;}
return false;}};HistoryAPI={obj_nav:null,init:function(){window.onpopstate=HistoryAPI.onpopstate;HistoryAPI.obj_nav=document.querySelector('#myNavigator');HistoryAPI.obj_nav.addEventListener("postpop",HistoryAPI.postpop);HistoryAPI.obj_nav.addEventListener("postpush",HistoryAPI.postpush);document.addEventListener("backbutton",HistoryAPI.onbackbutton);history.replaceState(null,T.title_page_chat,'');},postpop:function(event){return;var page_old=event.leavePage;var page=event.enterPage;if(page_old.id==='page_restore_chat.tpl')return;if(page.id==='page_start')return;if(history.state&&history.state.id!==page.id){history.back();}},postpush:function(event){var page=event.enterPage;if(page.id==='page_restore_chat.tpl')return;history.pushState({id:page.id},page.title,'');},onpopstate:function(event){if(HistoryAPI.onbackbutton()){var page=UI.getCurrentPage();history.pushState({id:page.id},page.title,'');event.preventDefault();return;}
UI.popPage().then(function(is_popped){if(is_popped)history.back();});return;if(!event.state){UI.popPage();}else if(event.state.id&&event.state.id!=="page_start"){UI.popPage();}},onbackbutton:function(event){var current_page=UI.getCurrentPage();if(current_page.id!=="page_chat.tpl"){if(!event){return false;}else{if(UI.popPage()===false&&Native&&Native.exit)Native.exit();return true;}}
if(Chat.state===Chat.STATE.IDLE){Chat.stop();return;}
if(Chat.state!==Chat.STATE.IN_PROGRESS){Chat.stopChat();return;}
ons.notification.confirm({message:T.configration_stop_chat,callback:function(answer){if(answer)Chat.stopChat();}});return true;}};Dialog=function(data){this.Messages=[];var that=this;if(typeof(data)!=='undefined'){this.data=data;for(var key in data){if(!data.hasOwnProperty(key))continue;this[key]=data[key];}}
this.onLoaded=function(callback){if(isPromise(that._id)){that._id.then(function(){callback(that);});}else{callback(that);}};this.addMessage=function(msg){that.Messages.push(msg);var num=that.Messages.length-1;that.onLoaded(function(dialog){msg.dialog_id=dialog._id;DB.messages.add(msg).then(function(msg_id){that.Messages[num]._id=msg_id;});});};this.getMessagesCount=function(){return that.Messages.length};this.getPhotosCount=function(){var cnt=0;Array.from(that.Messages).forEach(function(msg){if(typeof(msg.Type)!=='undefined'&&msg.Type===protos.Message.TYPE.PHOTO){cnt++;}});return cnt;};this.setSaved=function(is_saved){that.onLoaded(function(){that.data.saved=is_saved|0;DB.dialogs.put(that.data);});};this.delete=function(){that.onLoaded(function(){DB.dialogs.delete(that._id);DB.messages.getByIndex('dialog_id',that._id).then(function(messages){Array.from(messages).forEach(function(msg){DB.messages.delete(msg._id);});});});};};Dialog.new=function(opponent_id,opponent_name){var data={opponent_id:opponent_id,opponent_name:opponent_name,ts_start:new Date()/1000|0,saved:0};var d=new Dialog(data);d._id=DB.dialogs.add(data).then(function(id){d._id=id;});return d;};Dialog.get=function(dialog_id){var d=new Dialog();d._id=DB.dialogs.get(dialog_id).then(function(data){d.data=data;d._id=data._id;});DB.messages.getByIndex('dialog_id',dialog_id).then(function(messages){Array.from(messages).forEach(function(msg){d.Messages.push(msg);});});return d;};Dialog.__loadDialogsFromData=function(dialogsData,callback){var dialogs=[];var num=0,finished=false;var finish=function(){if(finished){throw 'already finished';}
num--;if(num<=0){finished=true;callback(dialogs);}};Array.from(dialogsData).forEach(function(data){var d=new Dialog(data);dialogs.push(d);num++;DB.messages.getByIndex('dialog_id',data._id).then(function(messages){Array.from(messages).forEach(function(msg){d.Messages.push(msg);});finish();});});};Dialog.getAll=function(callback){DB.dialogs.getAll().then(function(dialogsData){Dialog.__loadDialogsFromData(dialogsData,callback);});};Dialog.getSaved=function(callback){DB.dialogs.getByIndex('saved',1).then(function(dialogsData){Dialog.__loadDialogsFromData(dialogsData,callback);});};ChatHistory={cache:null,dialog:null,init:function(){Observer.addListener(save_scope(this,this.event_new_message),EVENT.MESSAGE_SENT,EVENT.MESSAGE_RECEIVED,EVENT.MESSAGE_SYSTEM);Observer.addListener(ChatHistory.startDialog,EVENT.CHAT_STARTED);var last_id=DataStorage.getLocal('history_dialog_id');if(last_id){ChatHistory.dialog=Dialog.get(last_id);}},startDialog:function(){ChatHistory.dialog=Dialog.new(DataStorage.get("opponent_id"),DataStorage.get('opponent_name'));ChatHistory.dialog.onLoaded(function(){DataStorage.setLocal('history_dialog_id',ChatHistory.dialog._id);});ChatHistory.clear();Dialog.getAll(function(dialogs){dialogs=Array.from(dialogs).filter(function(d){return!d.data.saved;});dialogs=Array.from(dialogs).sort(function(a,b){return b._id-a._id;});for(var i=dialogs.length-1;i>=C.recent_dialogs_cap;i--){dialogs[i].delete();}});},clear:function(){DataStorage.delLocal('history');ChatHistory.cache=null;},event_new_message:function(event,item){if(event===EVENT.MESSAGE_SYSTEM){item={Type:protos.Message.TYPE.SYSTEM,Body:item};}else if(item.Id){item=protos.Message.toObject(item);if(item.Type===protos.Message.TYPE.PHOTO&&item.timeLimit){item.Body='';}
delete(item.State);}
if(!ChatHistory.dialog)ChatHistory.startDialog();ChatHistory.dialog.addMessage(item);},getMessageByNum:function(num,history){if(history===undefined){history=ChatHistory.getHistory();}
for(var key in history){if(!history.hasOwnProperty(key))continue;var item=history[key];if(item.Id&&item.Id==num){return item;}}
return null;},getHistory:function(){if(!ChatHistory.dialog)return[];return ChatHistory.dialog.Messages;},prepareReplyList:function(reply_list){if(!Array.isArray(reply_list)||reply_list.length<1)return[];var result=[];for(var key in reply_list){if(!reply_list.hasOwnProperty(key))continue;var msg=ChatHistory.getMessageByNum(reply_list[key]);if(msg.Body&&msg.Body.length>0){result.push(msg.Id|0);}else if(msg.replyTo){result=result.concat(ChatHistory.prepareReplyList(msg.replyTo));}else if(msg.Type===protos.Message.TYPE.PHOTO&&!msg.Body){result.push(msg.Id|0);}}
result=result.reverse().filter(function(e,i,arr){return arr.indexOf(e,i+1)===-1;}).reverse();return result;},sendHistory:function(){var list=ChatHistory.getHistory();var result=protos.History.create();result.OpponentId=DataStorage.get("opponent_id");result.State=protos.STATE.DIALOG_HISTORY;result.NextMsgId=Chat.next_message_id;Array.from(list).forEach(function(item){if(!item.Type||!item.Body||!item.Id)return;if(item.Type!==protos.Message.TYPE.TEXT&&item.Type!==protos.Message.TYPE.PHOTO)return;result.Messages.push(item);});Chat.send(protos.History,result);},restoreHistory:function(history){return;ChatHistory.clear();UIMessages.clear();Chat.natural_history=true;var i_am_odd=history.NextMsgId%2!==0;Array.from(history.Messages).forEach(function(msg){var out=(msg.Id%2===0)===i_am_odd;if(out)Chat.next_message_id=msg.Id+2;UIMessages.addMessage(msg);});}};Chat={STATE:{IDLE:0,IN_PROGRESS:1,RESTORING:2,LOOKING_FOR_OPPONENT:3},ws_url:'',websocket:null,state:0,active:true,timeout_connection:5000,timeout_between_retries:2000,reconnect_timeout_id:0,connect_callback:null,natural_history:false,last_user_is_typing_sent:0,next_message_id:-1,reply_map:[],init:function(ws_url){ws_url=ws_url.replace('127.0.0.1',window.location.hostname);ws_url=ws_url.replace('{$hostname}',window.location.hostname);ws_url=ws_url.replace('ws.localhost','localhost');ws_url=ws_url.replace('ws.127.0.0.1','127.0.0.1');if(/\b(?:[0-9]{1,3}\.){3}[0-9]{1,3}\b/.test(window.location.hostname)){ws_url=ws_url.replace('ws.','');}
ws_url+=window.location.search;Chat.ws_url=ws_url;Chat.state=DataStorage.getLocal('chat_state');},initPage:function(){document.getElementById('btn-cancel').onclick=Chat.stop;if(DataStorage.getSession("restore_sess_id")){Chat.setState(Chat.STATE.RESTORING);}
switch(Chat.state){case Chat.STATE.RESTORING:UI.showModal('modal-chat-restoring',true);break;case Chat.STATE.IDLE:Chat.setState(Chat.STATE.LOOKING_FOR_OPPONENT,true);break;}
Chat.connect();},connect:function(callback){if(Chat.reconnect_timeout_id){return;}
if(Chat.websocket){if(Chat.websocket.readyState===WebSocket.OPEN||Chat.websocket.readyState===WebSocket.CONNECTING){return;}}
Chat.connect_callback=callback;Chat.websocket=new WebSocket(Chat.ws_url);Chat.websocket.onopen=Chat.onOpen;Chat.websocket.onclose=Chat.onClose;Chat.websocket.onmessage=Chat.onMessage;Chat.websocket.onerror=Chat.onError;Chat.reconnect_timeout_id=setTimeout(function(){if(!Chat.websocket||Chat.websocket.readyState!==WebSocket.OPEN){if(Chat.websocket)Chat.websocket.close();if(UI.getCurrentPage().id!=="page_chat.tpl"){Chat.reconnect_timeout_id=0;return;}
Chat.reconnect_timeout_id=setTimeout(function(){Chat.reconnect_timeout_id=0;Chat.connect();},Chat.timeout_between_retries);}},Chat.timeout_connection);},disconnect:function(){if(!Chat.websocket)return;clearTimeout(Chat.reconnect_timeout_id);Chat.reconnect_timeout_id=null;Chat.setState(Chat.STATE.IDLE);Chat.websocket.close();Chat.websocket=null;},setState:function(value){var old=Chat.state;Chat.state=value;DataStorage.setLocal('chat_state',value);if(Chat.state===Chat.STATE.IN_PROGRESS){ReportModal.enable();}else if(old!==Chat.STATE.IN_PROGRESS){ReportModal.disable();}
if(value===Chat.STATE.LOOKING_FOR_OPPONENT){UI.showModal('modal-chat-search',true);}
if(old===value)return;Observer.fire(EVENT.CHAT_STATE_CHANGED,old,value);},add_system_message:function(body){Observer.fire(EVENT.MESSAGE_SYSTEM,body);},startChat:function(){var page=UI.getCurrentPage();if(!page||!page.id||page.id!=='page_chat.tpl'){Chat.disconnect();return;}
Chat.last_user_is_typing_sent=0;document.getElementById('btn-send').onmousedown=Chat.sendMessage;document.getElementById('message')._input.onkeypress=function(e){if(e.keyCode===13)Chat.sendMessage(e);};UI.showInput();if(Chat.next_message_id>0){UI.hideModal();}
if(Chat.state===Chat.STATE.RESTORING){if(!Chat.natural_history)UIMessages.restoreHistory();Chat.setState(Chat.STATE.IN_PROGRESS);Chat.natural_history=true;UI.focusInput();Observer.fire(EVENT.CHAT_RESTORED);return}
Chat.natural_history=false;Chat.setState(Chat.STATE.IN_PROGRESS);Observer.fire(EVENT.CHAT_STARTED);UI.focusInput();},stopChat:function(dont_open_start_page){var msg=protos.Base.create();msg.State=protos.STATE.QUIT;Chat.send(protos.Base,msg);Chat.stop(dont_open_start_page);},pauseChat:function(){if(Chat.state===Chat.STATE.IN_PROGRESS){this.stopChat(true);}
UI.hideModal();UIMessages.hideUserTyping();UI.setMessagesHidden(false);UI.hideInput();Chat.setState(Chat.STATE.IDLE);},stop:function(dont_open_start_page){UI.hideModal();if(dont_open_start_page===true){UIMessages.addSearchNextBtn();return;}
Chat.disconnect();UI.popPage();},nextChat:function(){if(RateUsAlert.mustBeShown()){if(Chat.state===Chat.STATE.IN_PROGRESS){Chat.add_system_message(T.system_message_chat_ended);Chat.pauseChat();}
RateUsAlert.show();return;}
if(!Chat.websocket||Chat.websocket.readyState!==WebSocket.OPEN){Chat.connect(Chat.nextChat);return;}
UIMessages.clear();ChatHistory.clear();Chat.setState(Chat.STATE.LOOKING_FOR_OPPONENT);var msg=NewClientInitMessage();msg.State=protos.STATE.LOOK_FOR_NEXT_CHAT;Chat.send(protos.ClientInit,msg);},onOpen:function(evt){if(Chat.reconnect_timeout_id){clearTimeout(Chat.reconnect_timeout_id);Chat.reconnect_timeout_id=0;}
if(UI.getModalName()==='modal-chat-reconnecting'){UI.hideModal();}
if(Chat.connect_callback){Chat.connect_callback(evt);return;}
var msg=NewClientInitMessage();msg.State=protos.STATE.INIT;if(Chat.state===Chat.STATE.RESTORING){var restore_session=DataStorage.getSession("restore_sess_id");if(restore_session){msg.OpponentId=restore_session;msg.State=protos.STATE.RESTORE_BY_CHAT_CODE;DataStorage.delSession('restore_sess_id');}else{Chat.state=Chat.STATE.IN_PROGRESS;}}
if(Chat.state===Chat.STATE.IN_PROGRESS){msg.State=protos.STATE.CHAT_IN_PROGRESS;msg.OpponentId=DataStorage.get("opponent_id","");}
Chat.send(protos.ClientInit,msg);},onMessage:function(evt){var reader=new FileReader();reader.addEventListener("loadend",function(){var data=new Uint8Array(reader.result);var msg=protos.Base.decode(data);Chat.process_message(msg,data);});reader.readAsArrayBuffer(evt.data);},process_message:function(msg,data){switch(msg.State){case protos.STATE.LOOKING_FOR_OPPONENT:msg=protos.ServerStateChange.decode(new Uint8Array(data));DataStorage.set(C.sess_cookie_name,msg.SessionId,true);DataStorage.set(C.sess_cookie_name+"s",msg.SessionSecret,true);Chat.setState(Chat.STATE.LOOKING_FOR_OPPONENT);break;case protos.STATE.CHAT_IN_PROGRESS:msg=protos.ServerStateChange.decode(new Uint8Array(data));Chat.next_message_id=msg.MsgStartId;DataStorage.setLocal('next_message_id',Chat.next_message_id);DataStorage.set("opponent_id",msg.OpponentId);DataStorage.set('opponent_name',msg.OpponentName);Chat.startChat();Chat.add_system_message(UI.wrapNickname(T.system_message_chat_started,Chat.getOpponentName()));UI.confirmChatStart(msg.OpponentName);break;case protos.STATE.CHAT_RESTORED:UI.setMessagesHidden(false);Chat.next_message_id=DataStorage.getLocal('next_message_id',Chat.next_message_id);Chat.setState(Chat.STATE.RESTORING);Chat.startChat();Chat.add_system_message(UI.wrapNickname(T.msg_connection_restored,Chat.getOpponentName()));break;case protos.STATE.MESSAGE:msg=protos.Message.decode(new Uint8Array(data));Chat.natural_history=true;Observer.fire(EVENT.MESSAGE_RECEIVED,msg);if(Chat.next_message_id<=0){Chat.next_message_id=msg.Id+1;UI.showInput();}
break;case protos.STATE.STRANGER_HAS_LEFT:if(Chat.state!==Chat.STATE.IN_PROGRESS)break;Chat.add_system_message(UI.wrapNickname(T.msg_stranger_has_left,Chat.getOpponentName()));this.pauseChat();break;case protos.STATE.STRANGER_DISCONNECTED:if(Chat.state!==Chat.STATE.IN_PROGRESS)break;UIMessages.hideUserTyping();UI.hideModal();UI.setMessagesHidden(false);Chat.setState(Chat.STATE.RESTORING);Chat.add_system_message(UI.wrapNickname(T.msg_connection_with_stranger_is_broken,Chat.getOpponentName()));Chat.add_system_message(T.msg_restoring_connection);UI.hideInput();break;case protos.STATE.REFRESH_UI:DataStorage.setLocal('do_state_restore',true);window.location.reload(true);break;case protos.STATE.PING:var msg=protos.Base.create();msg.State=protos.STATE.PONG;this.send(protos.Base,msg);break;case protos.STATE.USER_IS_TYPING:Observer.fire(EVENT.STRANGER_TYPING);break;case protos.STATE.USER_NOT_TYPING:Observer.fire(EVENT.STRANGER_NOT_TYPING);break;case protos.STATE.FAIL:case protos.STATE.DISCONNECT:Chat.stop();break;case protos.STATE.IDLE:Chat.stop(true);Chat.setState(protos.STATE.IDLE);break;case protos.STATE.CMD_TRANSFER_HISTORY:ChatHistory.sendHistory();break;case protos.STATE.DIALOG_HISTORY:msg=protos.History.decode(new Uint8Array(data));ChatHistory.restoreHistory(msg);UI.hideModal();break;}
if(msg.SessionId){DataStorage.set(C.sess_cookie_name,msg.SessionId,true);}
if(msg.SessionSecret){DataStorage.set(C.sess_cookie_name+"s",msg.SessionSecret,true);}},onError:function(evt){if(Chat.state===Chat.STATE.IDLE)return;Chat.websocket.close();setTimeout(Chat.connect,Chat.timeout_between_retries);},onClose:function(evt){if(Chat.state===Chat.STATE.IDLE)return;document.getElementById('btn-camera-cancel').click();UI.showModal('modal-chat-reconnecting',true);Chat.connect();},send:function(msg_prototype,msg){if(!Chat.websocket||Chat.websocket.readyState!==WebSocket.OPEN){return;}
msg=msg_prototype.encode(msg);msg=msg.finish();Chat.websocket.send(msg.buffer.slice(msg.byteOffset,msg.byteOffset+msg.length));},sendTyping:function(current_text){if(Chat.state!==Chat.STATE.IN_PROGRESS)return;if(current_text.length<1)return;var ts=new Date()/1000|0;if(Chat.last_user_is_typing_sent!==0&&ts-Chat.last_user_is_typing_sent<C.typing_timeout)return;Chat.last_user_is_typing_sent=ts;var msg=protos.Base.create();msg.State=protos.STATE.USER_IS_TYPING;Chat.send(protos.Message,msg);},sendMessage:function(event){event.preventDefault();var msg_obj=document.querySelector('#message');var reply_map=ChatHistory.prepareReplyList(Chat.reply_map);var body=msg_obj.value.trim();if(body.length<1&&reply_map.length<1)return false;var msg=protos.Message.create();msg.Id=Chat.next_message_id;msg.State=protos.STATE.MESSAGE;msg.Type=protos.Message.TYPE.TEXT;msg.Outgoing=true;if(body.length>0){msg.Body=body;}
if(reply_map.length>0){msg.replyTo=reply_map;UIMsgSelection.btn_reply_cancel();}
Chat.send(protos.Message,msg);Chat.next_message_id+=2;DataStorage.setLocal('next_message_id',Chat.next_message_id);Chat.last_user_is_typing_sent=0;msg_obj.value='';Observer.fire(EVENT.MESSAGE_SENT,msg);return false;},sendPhoto:function(data_uri,time_limit){var msgid=Chat.next_message_id;Chat.next_message_id+=2;DataStorage.setLocal('next_message_id',Chat.next_message_id);var sid=DataStorage.get(C.sess_cookie_name,"");var ssid=DataStorage.get(C.sess_cookie_name+"s","");var msg=protos.Message.create();msg.Type=protos.Message.TYPE.PHOTO;msg.Body=data_uri;msg.timeLimit=time_limit;msg.Outgoing=true;var msg_obj=UIMessages.addMessage(msg);Xhr.PostFile("/upload",{"msgid":msgid,"photo":dataURLtoBlob(data_uri),"limit":time_limit?time_limit:0,"sid":sid,"ssid":ssid},function(body,response_code){if(response_code!==200){return;}
if(sid!==DataStorage.get(C.sess_cookie_name,"")){return;}
msg.Id=msgid;msg_obj.setAttribute('data-id',msgid);Html.removeClass(msg_obj.querySelector('.message'),'sending');ChatHistory.event_new_message(EVENT.MESSAGE_SENT,msg);if(time_limit){PhotoTimer.init(msg_obj.querySelector('img'),time_limit);}},function(event){if(sid!==DataStorage.get(C.sess_cookie_name,"")){event.srcElement.abort();return;}});},getOpponentId:function(force){if(!force&&Chat.state!==Chat.STATE.IN_PROGRESS){return '';}
return DataStorage.get("opponent_id",0);},getOpponentName:function(){var name=DataStorage.get('opponent_name',name);return name?name:'Stranger';}};DataStorage={set:function(key,val,force_cookie){if(!DataStorage.setLocal("cookie_"+key,val)||force_cookie){document.cookie=key+"="+val+"; expires=Thu, 18 Dec 2099 12:00:00 UTC; path=/";}},get:function(key,def){var nameEQ=key+"=";var ca=document.cookie.split(';');for(var i=0;i<ca.length;i++){var c=ca[i];while(c.charAt(0)===' ')c=c.substring(1,c.length);if(c.indexOf(nameEQ)===0)return c.substring(nameEQ.length,c.length);}
var res=DataStorage.getLocal("cookie_"+key,null);if(res!==null){DataStorage.set(key,res);return res;}
return def?def:null;},del:function(key){document.cookie=key+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";DataStorage.delLocal("cookie_"+key);},setLocal:function(key,val){if(typeof(Storage)==="undefined")return false;try{localStorage.setItem(key,JSON.stringify(val));}catch(err){return false;}
return true;},getLocal:function(key,def){if(typeof(Storage)==="undefined")return false;var res=localStorage.getItem(key);if(res===null)return typeof(def)!=='undefined'?def:null;if(res==='undefined')return def;return JSON.parse(res);},delLocal:function(key){if(typeof(Storage)==="undefined")return false;localStorage.removeItem(key);},setSession:function(key,val){if(typeof(Storage)==="undefined")return false;try{sessionStorage.setItem(key,JSON.stringify(val));}catch(err){return false;}
return true;},getSession:function(key,def){if(typeof(Storage)==="undefined")return false;var res=sessionStorage.getItem(key);if(res===null)return typeof(def)!=='undefined'?def:null;return JSON.parse(res);},delSession:function(key){if(typeof(Storage)==="undefined")return false;sessionStorage.removeItem(key);}};TabsComm={last_id:0,last_sent_message:{},TYPE:{ACTIVE_TAB_PING:3,ACTIVE_TAB_PONG:4,DEACTIVATE:5,DEACTIVATION_COMPLETE:6},init:function(){window.addEventListener("storage",TabsComm.listener);},listener:function(event){if(event.newValue===null)return;if(event.key!=='tab_message')return;var body=JSON.parse(event.newValue);if(body['id']>TabsComm.last_id){TabsComm.last_id=body['id'];}
switch(body.type){case TabsComm.TYPE.ACTIVE_TAB_PING:if(UI.active){TabsComm.sendEvent(TabsComm.TYPE.ACTIVE_TAB_PONG);}
break;case TabsComm.TYPE.ACTIVE_TAB_PONG:if(ons.platform.isWebView()){UI.makeActive();return;}
case TabsComm.TYPE.DEACTIVATE:if(!UI.active)return;UI.makeInactive();Chat.websocket.close();TabsComm.sendEvent(TabsComm.TYPE.DEACTIVATION_COMPLETE);break;}},sendEvent:function(type,body){TabsComm.last_sent_message={id:++TabsComm.last_id,type:type,payload:body};DataStorage.setLocal('tab_message',TabsComm.last_sent_message);DataStorage.delLocal('tab_message');}};_tpl_cache={};function Tpl(tpl_id,options,return_html){var html=_tpl_cache[tpl_id];if(!html){html=document.getElementById(tpl_id).cloneNode(true);html.id='';_tpl_cache[tpl_id]=html=Html.getElementHtml(html);}
var re=/{\$([^|}]+)?}/g,reExp=/(^( )?(if|for|else|switch|case|break|{|}))(.*)?/g,code='var r=[];\n',cursor=0,match;var add=function(line,js){js?(code+=line.match(reExp)?line+'\n':'r.push(this.'+line+');\n'):(code+=line!==''?'r.push("'+line.replace(/"/g,'\\"')+'");\n':'');return add;};while(match=re.exec(html)){add(html.slice(cursor,match.index))(match[1],true);cursor=match.index+match[0].length;}
add(html.substr(cursor,html.length-cursor));code+='return r.join("");';html=new Function(code.replace(/[\r\t\n]/g,'')).apply(options);return return_html?html:Html.createElement(html);}
Xhr={request:function(params,func,onProgress){var req=new XMLHttpRequest();req.onreadystatechange=function(){if(req.readyState===4&&func&&typeof(func)==='function'){var body=req.response;if(req.getResponseHeader('content-type')==='application/json'){body=JSON.parse(req.responseText);}
func(body,req.status);}};var data=params.data;if(params.data&&!params.raw){data=new FormData();for(var key in params.data){data.append(key,params.data[key]);}}
req.open(params.method,params.url,true);if(params.method==='POST'){if(params.raw){req.setRequestHeader("Content-type","application/octet-stream");req.responseType="arraybuffer";}else if(typeof(params["Content-type"])!=='undefined'){if(params["Content-type"])req.setRequestHeader("Content-type",params["Content-type"]);}else{req.setRequestHeader("Content-type","multipart/form-data");}}
if(onProgress)req.onprogress=onProgress;req.send(data);return req;},Get:function(url,data,func,scope){return Xhr.request({url:url,method:'GET',data:data},func?func:null);},Post:function(url,data,func,scope){return Xhr.request({url:url,method:'POST',data:data},func?func:null);},PostRaw:function(url,data,func,scope){return Xhr.request({url:url,method:'POST',data:data,raw:true},func?func:null);},PostFile:function(url,data,func,onProgress){return Xhr.request({url:url,method:'POST',data:data,"Content-type":""},func?func:null,onProgress?onProgress:null);}};SizeOptimizer={width:1280,height:720,div:null,get_div:function(){if(SizeOptimizer.div===null){SizeOptimizer.div=document.getElementById('main_wrapper');}
return SizeOptimizer.div;},optimize:function(){var div=SizeOptimizer.get_div();var w=window.innerWidth;var h=window.innerHeight;if(w<=SizeOptimizer.width){div.className='';div.style.height='100%';div.style.width='100%';return;}
div.style.width=SizeOptimizer.width+'px';if(h<=SizeOptimizer.height){div.className='';div.style.height='100%';return;}
div.style.height=SizeOptimizer.height+'px';div.className='centered';}};Time={formatTime:function(timestamp){return new Date(timestamp*1000).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});},formatDuration:function(delta){var hours=delta/3600|0;var minutes=(delta-hours*3600)/60|0;var d_string='';if(hours>0){d_string=hours+' '+T.ROOM.HOURS;}
if(minutes>0){d_string+=(d_string===''?'':' ')+minutes+' '+T.ROOM.MIN;}
return d_string;},formatDate:function(timestamp){return new Date(timestamp*1000).toLocaleDateString([],{day:'numeric',month:'short'})},isToday:function(timestamp){return new Date().toDateString()===new Date(timestamp*1000).toDateString();},};UI={modal_obj:null,modal_name:'',active:true,msg_tmp_obj:null,int_photo:null,init:function(){Observer.addListener(save_scope(this,function(event,old_state,new_state){if(new_state===Chat.STATE.IN_PROGRESS){var node=document.getElementById('timer_photo');if(!node)return;document.getElementById('btn-camera').setAttribute('disabled',1);node.innerText=C.ph_delay;node.style.display='';this.int_photo=setInterval(this.photo_timer,C.ph_delay>0?1000:0);}else if(old_state===Chat.STATE.IN_PROGRESS){if(this.int_photo){clearInterval(this.int_photo);this.int_photo=null;}}
if(new_state===Chat.STATE.IDLE){UI.hideInput();}}),EVENT.CHAT_STATE_CHANGED);},photo_timer:function(){if(!UI.int_photo)return;var node=document.getElementById('timer_photo');if(!node)return;var value=node.innerText|0;value--;if(value<=0){node.style.display='none';document.getElementById('btn-camera').removeAttribute('disabled');clearInterval(UI.int_photo);UI.int_photo=null;}else{node.innerText=value;}},redraw:function(node){if(!node)node=document.body;window.getComputedStyle(node).opacity;},scrollDown:function(){var chat=document.getElementById('msg-list');if(chat){chat.scrollTop=99999999999999;}},pushPage:function(tpl_name,pop_previous){if(pop_previous){UI.popPage(true).then(function(){UI.pushPage(tpl_name);});return;}
return document.querySelector('#myNavigator').pushPage(tpl_name);},popPage:function(no_anim){var options=no_anim?{'animation':'none'}:{};if(document.querySelector('#myNavigator').pages.length<=1)return new Promise(function(then){then(false)});return document.querySelector('#myNavigator').popPage(options);},getCurrentPage:function(){var pages=document.querySelector('#myNavigator').pages;if(pages.length<=0)return null;return pages[pages.length-1];},showModal:function(modal_id,close_previous){if(close_previous)UI.hideModal();UI.modal_name=modal_id;UI.modal_obj=document.getElementById(modal_id);UI.modal_obj.show();},showLoading:function(text){var obj=document.getElementById('modal-loading');obj.querySelector('.content').innerHTML=text;UI.showModal('modal-loading',true)},hideLoading:function(){if(UI.modal_name==='modal-loading'){UI.hideModal()}},hideModal:function(){UIMsgSelection.btn_clear();UIMsgSelection.hide_ui();var alert=document.querySelector('ons-alert-dialog');if(alert)alert.hide();if(UI.modal_obj===null)return;UI.modal_obj.hide();UI.modal_obj=null;UI.modal_name='';},getModalName:function(){return UI.modal_name;},makeInactive:function(){if(!UI.active)return;UI.active=false;UI.showModal('modal-tab-deactivated');document.getElementById('btn-activate-tab').onclick=UI.makeActive;},makeActive:function(){if(UI.active)return;TabsComm.sendEvent(TabsComm.TYPE.DEACTIVATE);location.reload();},focusInput:function(){var input=document.querySelector('#message');if(input)input._input.focus();},setMessagesHidden:function(is_hidden){var output=UIMsgSelection.obj;if(!output)return;if(is_hidden){if(output.className.indexOf('hide_messages')<0)
output.className+=' hide_messages';}else{output.className=output.className.replace(/hide_messages/g,'');UI.scrollDown();}},confirmChatStart:function(nickname){return;UI.setMessagesHidden(true);ons.notification.alert(T.chat_start_confirm_body.replace('{nickname}',nickname),{buttonLabels:[T.chat_start_btn_skip,T.chat_start_btn_yes],primaryButtonIndex:1,title:T.chat_start_confirm_title,modifier:"alert-tos",callback:function(btn_index){if(btn_index){UI.setMessagesHidden(false);}else{Chat.nextChat();}}});},wrapNickname:function(str,name){return str.replace('{$name}',Tpl('tpl-stranger-nickname',{name:name},true));},hideInput:function(){try{document.getElementById('input-bar').style.display='none';}catch(e){}},showInput:function(){try{document.getElementById('input-bar').style.display='block';}catch(e){}}};UIMessages={inited:false,user_typing_timeout:null,user_typing_obj:null,msgListComponent:null,init:function(obj){UIMessages.msgListComponent=new ComponentMessagesList(obj);if(this.inited)return;this.inited=true;Observer.addListener(save_scope(this,this.event_new_message),EVENT.MESSAGE_RECEIVED,EVENT.MESSAGE_SENT);Observer.addListener(save_scope(this,this.event_new_system_message),EVENT.MESSAGE_SYSTEM);Observer.addListener(save_scope(this,this.event_typing),EVENT.STRANGER_TYPING,EVENT.STRANGER_NOT_TYPING);Observer.addListener(save_scope(this,this.event_chat_started),EVENT.CHAT_STARTED);},event_chat_started:function(event){UIMessages.msgListComponent.clear();},event_new_message:function(event,msg_proto){UIMessages.msgListComponent.addMessage(msg_proto);if(event===EVENT.MESSAGE_RECEIVED)this.hideUserTyping();UI.scrollDown();},event_new_system_message:function(event,body){UIMessages.msgListComponent.addMessage({Type:protos.Message.TYPE.SYSTEM,Body:body});},event_typing:function(event){if(event===EVENT.STRANGER_TYPING){this.showUserTyping();}else if(event===EVENT.STRANGER_NOT_TYPING){this.hideUserTyping();}},addMessage:function(msg){return UIMessages.msgListComponent.addMessage(msg);},addSearchNextBtn:function(){UIMessages.msgListComponent.addObject(Tpl('tpl-msg-chat-idle'));UI.scrollDown();},clear:function(){UIMessages.msgListComponent.clear();},showUserTyping:function(){if(this.user_typing_timeout)return;this.user_typing_timeout=setTimeout(save_scope(this,this.hideUserTyping),C.typing_timeout*1000);UIMessages.msgListComponent.showUserTyping(Chat.getOpponentName());UI.scrollDown();},hideUserTyping:function(){if(!this.user_typing_timeout)return;clearTimeout(this.user_typing_timeout);this.user_typing_timeout=null;UIMessages.msgListComponent.hideUserTyping();},restoreHistory:function(){UIMessages.msgListComponent.clear();UIMessages.msgListComponent.loadMessages(ChatHistory.getHistory());UI.scrollDown();}};HTMLElementStars=function(obj,stars_count){this.onmouseover=function(event){var node=event.target;while(node.previousSibling){node=node.previousSibling;if(!Html.hasClass(node,'star'))continue;if(Html.hasClass(node,'active_hover'))continue;Html.addClass(node,'active_hover');}};this.onmouseout=function(event){var node=event.target;while(node.previousSibling){node=node.previousSibling;if(!Html.hasClass(node,'star'))continue;Html.removeClass(node,'active_hover');}};this.onclick=function(event){var node=event.target;if(typeof(node.__num)==='undefined')return;var stars=node.__num;Array.from(node.parentNode.childNodes).forEach(function(node){Html.removeClass(node,'active');});Html.addClass(node,'active');while(node.previousSibling){node=node.previousSibling;if(!Html.hasClass(node,'star'))continue;if(Html.hasClass(node,'active'))continue;Html.addClass(node,'active');}
this.set_value(stars);};this.value=0;this.obj=obj;obj.value=0;if(!stars_count)stars_count=5;for(var i=0;i<stars_count;i++){var node=document.createElement('span');node.className='star';node.onmouseover=this.onmouseover;node.onmouseout=this.onmouseout;node.onclick=save_scope(this,this.onclick);node.__num=i+1;obj.appendChild(node);}
window.getComputedStyle(this.obj).opacity;this.callbacks=[];this.addCallback=function(callback){this.callbacks.push(callback);};this.set_value=function(stars){this.obj.value=stars;this.value=stars;for(var key in this.callbacks){if(!this.callbacks.hasOwnProperty(key))continue;var callback=this.callbacks[key];callback(stars);}};this.reset=function(){Array.from(this.obj.childNodes).forEach(function(node){Html.removeClass(node,'active');});this.obj.value=0;this.value=0;};};UIMsgSelection={selected_count:0,ui_shown:false,inited:false,obj:null,init:function(obj){this.obj=obj;if(UIMsgSelection.inited)return;UIMsgSelection.inited=true;document.getElementById('btn-reply').onclick=UIMsgSelection.btn_reply;document.getElementById('btn-copy-to-clipboard').onclick=UIMsgSelection.btn_copy;document.getElementById('btn-clear-selection').onclick=UIMsgSelection.btn_clear;Observer.addListener(UIMsgSelection.clear,EVENT.CHAT_STARTED);Observer.addListener(UIMsgSelection.eventChatStateUpdated,EVENT.CHAT_STATE_CHANGED)},clear:function(){UIMsgSelection.selected_count=0;UIMsgSelection.hide_ui();UIMsgSelection.btn_reply_cancel();Chat.reply_map=[];},eventChatStateUpdated:function(event,old_state,new_state){var obj=document.getElementById('msg-command-list');if(Chat.state===Chat.STATE.IN_PROGRESS){obj.className=obj.className.replace(/chat_not_active/,'')}else if(obj.className.indexOf('chat_not_active')<0){obj.className+=' chat_not_active';if(Chat.state!==Chat.STATE.IDLE)UIMsgSelection.hide_ui();}},onclick:function(ev){var el=ev.target;while(el&&el.hasAttribute&&!el.hasAttribute('selectable')){el=el.parentNode;}
if(!el||!el.hasAttribute)return;if(el.className.indexOf('selected')>=0){el.className=el.className.replace(/selected/,'');UIMsgSelection.selected_count--;}else{el.className+=' selected';UIMsgSelection.selected_count++;}
UIMsgSelection.toggle_ui();},hide_ui:function(){if(!UIMsgSelection.ui_shown)return;document.getElementById('msg-command-list').hide();UIMsgSelection.ui_shown=false;},show_ui:function(){if(UIMsgSelection.ui_shown)return;document.getElementById('msg-command-list').show({callback:UIMsgSelection.__fix_ios_scroll});UIMsgSelection.ui_shown=true;},toggle_ui:function(){if(UIMsgSelection.selected_count>0){UIMsgSelection.show_ui();}else{UIMsgSelection.hide_ui();}},btn_clear:function(){if(UIMsgSelection.selected_count<1)return;Array.from(UIMsgSelection.obj.querySelectorAll('.selected')).forEach(function(el){el.className=el.className.replace(/selected/,'');});UIMsgSelection.selected_count=0;UIMsgSelection.toggle_ui();UI.focusInput();},btn_reply:function(){Chat.reply_map=[];Array.from(UIMsgSelection.obj.querySelectorAll('.selected')).forEach(function(el){if(!el.getAttribute)return;var id=el.getAttribute('data-id');if(id<=0)return;Chat.reply_map.push(id|0);});var obj=document.querySelector('.attachments');obj.querySelector(".remove").onclick=UIMsgSelection.btn_reply_cancel;obj.querySelector(".num").innerText=Chat.reply_map.length;obj.style.display='block';UIMsgSelection.btn_clear();},btn_reply_cancel:function(){Chat.reply_map=[];var list=document.querySelector('.attachments');if(list){list.style.display='';}
UI.focusInput();},btn_copy:function(){var text=[];Array.from(UIMsgSelection.obj.querySelectorAll('.selected')).forEach(function(el){text.push(el.innerText);});Clipboard.put(text.join("\n"));UIMsgSelection.btn_clear();ons.notification.toast(T.copied_to_clipboard,{timeout:300});UI.focusInput();},__fix_ios_scroll:function(){Html.removeClass(document.body,'ons-ios-scroll');Html.removeClass(document.body,'ons-ios-scroll-fix');}};ComponentMessagesList=function(obj){UIMsgSelection.init(obj);obj.onclick=UIMsgSelection.onclick;var that=this;var user_typing_obj=null;var history=[];this.clear=function(){UIMsgSelection.clear();obj.innerHTML='';user_typing_obj=null;history=[];};this.addMessage=function(msg){if(!msg||!msg.Type)return;history.push(msg);var msg_obj=null;if(msg.Type===protos.Message.TYPE.SYSTEM){msg_obj=Tpl('tpl-msg-system',{msg:msg.Body});}else{msg_obj=that.prepare_message_html(msg.Id,msg.Type,msg.Body,msg.replyTo,false,!msg.Outgoing);}
obj.appendChild(msg_obj);if(user_typing_obj&&user_typing_obj.parentNode){user_typing_obj.parentNode.removeChild(user_typing_obj);obj.appendChild(user_typing_obj);}
if(msg.Type===protos.Message.TYPE.PHOTO){UI.redraw(msg_obj);}
return msg_obj;};this.addObject=function(new_obj){obj.appendChild(new_obj);};this.showUserTyping=function(opponent_name){if(!user_typing_obj){user_typing_obj=Tpl('tpl-msg-system',{msg:UI.wrapNickname(T.stranger_is_typing,opponent_name)});}else if(user_typing_obj&&user_typing_obj.parentNode){return;}
obj.appendChild(user_typing_obj);};this.hideUserTyping=function(){if(!user_typing_obj||!user_typing_obj.parentNode)return;user_typing_obj.parentNode.removeChild(user_typing_obj);user_typing_obj=null;};this.loadMessages=function(messages){Array.from(messages).forEach(that.addMessage);};this.prepare_message_html=function(id,type,body,reply_to,return_html,incoming){if(!body)body='';var replied_messages='';if(Array.isArray(reply_to)&&reply_to.length>0){for(var key in reply_to){if(!reply_to.hasOwnProperty(key))continue;var message=ChatHistory.getMessageByNum(reply_to[key],history);if(!message)continue;var reply_id=message.Id?message.Id:0;replied_messages+=that.prepare_message_html(reply_id,message.Type,message.Body,null,true,!message.Outgoing);}
replied_messages=replied_messages.replace(/selectable/g,'');replied_messages=replied_messages.replace(/data-id/g,'data-reply-id');}
var body_obj=null;if(type===protos.Message.TYPE.TEXT||!body){body_obj=Tpl(type===protos.Message.TYPE.TEXT?'tpl-msg-text':'tpl-msg-photo-expired',{id:id,msg:body+replied_messages});}else{body_obj=Tpl('tpl-msg-photo',{id:id,msg:'<img>'+replied_messages});var img=body_obj.querySelector('img');if(!return_html){if(!id||incoming){var progress=document.createElement('ons-progress-circular');progress.setAttribute('indeterminate',1);body_obj.appendChild(progress);}
if(!id)Html.addClass(body_obj,'sending');if(incoming){Html.addClass(body_obj,'loading');img.onload=function(){Html.removeClass(body_obj,'loading');UI.scrollDown();UI.redraw(msg_obj);};}else
img.onload=UI.scrollDown;}
img.src=body;}
var msg_obj=Tpl(incoming?'tpl-msg-incoming':'tpl-msg-outgoing',{id:id,msg:''});msg_obj.appendChild(body_obj);return return_html?Html.getElementHtml(msg_obj):msg_obj;};};ReportModal={obj:null,obj_btn:null,opponent_id:'::default::',reason:-1,init:function(page){page.querySelector('#btn-report').onclick=ReportModal.show;ReportModal.obj_btn=page.querySelector('#btn-report');ReportModal.disable();if(ReportModal.obj)return;ReportModal.obj=document.querySelector('#modal-report');ReportModal.obj.querySelector('ons-button').onclick=ReportModal.send;Array.from(ReportModal.obj.querySelectorAll('input[type=radio]')).forEach(function(node){node.onchange=ReportModal.radio_selected;});},enable:function(){if(ReportModal.obj_btn)ReportModal.obj_btn.style.display='';},disable:function(){if(ReportModal.obj_btn)ReportModal.obj_btn.style.display='none';},show:function(){try{ReportModal.opponent_id=Chat.getOpponentId(true);}catch(e){ReportModal.opponent_id='::exception:: '+e;}
if(!ReportModal.opponent_id){ReportModal.opponent_id='::failed::';return;}
Array.from(ReportModal.obj.querySelectorAll('input[type=radio]')).forEach(function(node){node.checked=false;});ReportModal.obj.querySelector('textarea').setAttribute('disabled',"1");ReportModal.obj.querySelector('textarea').value='';ReportModal.obj.querySelector('ons-button').setAttribute('disabled',"1");UI.showModal('modal-report',true);},hide:function(){ReportModal.obj.hide();},radio_selected:function(event){if(!event.target.checked)return;var value=event.target.value;if(value==protos.Report.REASON.OTHER){ReportModal.obj.querySelector('textarea').removeAttribute('disabled');}else{ReportModal.obj.querySelector('textarea').setAttribute('disabled',"1");}
ReportModal.obj.querySelector('ons-button').removeAttribute('disabled');ReportModal.reason=value;},send:function(){var msg=protos.Report.create();msg.State=protos.STATE.REPORT;msg.OpponentID=ReportModal.opponent_id;msg.Reason=ReportModal.reason|0;if(msg.Reason==protos.Report.REASON.OTHER){var value=ReportModal.obj.querySelector('textarea').value;msg.Desc=value.substr(0,400);}
msg.Blacklist=ReportModal.obj.querySelector('#report-blacklist').checked;var list=ChatHistory.getHistory();msg.NextMsgId=Chat.next_message_id;Array.from(list).forEach(function(item){if(!item.Type||!item.Body||!item.Id)return;if(item.Type!==protos.Message.TYPE.TEXT&&item.Type!==protos.Message.TYPE.PHOTO)return;msg.Messages.push(item);});ReportModal.disable();Chat.send(protos.Report,msg);if(ReportModal.opponent_id===Chat.getOpponentId(true)){Chat.add_system_message(T.system_message_report_sent);Chat.setState(Chat.STATE.IDLE);}
ReportModal.hide();}};RateUsAlert={inited:false,obj:null,stars:null,init:function(){if(this.inited)return;this.inited=true;this.obj=document.getElementById('alert-rate-us');this.stars=new HTMLElementStars(this.obj.querySelector('.stars'),5);this.stars.addCallback(save_scope(this,this.onStarsChanged));this.obj.querySelector('.btn_dont_ask').onclick=save_scope(this,this.btn_dont_show);this.obj.querySelector('.btn_ask_later').onclick=save_scope(this,this.btn_ask_later);this.obj.querySelector('.btn_done').onclick=save_scope(this,this.btn_done);},canBeShown:function(){if(DataStorage.getLocal('feedback_stars',-1)>=0)return false;if(DataStorage.getSession('feedback_stars',-1)>=0)return false;if(typeof(Native)!=='undefined'){if(State.isAndroid()){return Native.getAppBuild&&Native.getAppBuild()>=102;}else if(State.isIos()){return Native.getAppBuild&&Native.getAppBuild()>=105;}}
return false;},mustBeShown:function(){if(!this.canBeShown())return false;if(Stat.chats_count<3)return false;if(Stat.msg_received<15)return false;return true;},show:function(){this.init();stat("RateUs","show");Html.removeClass(this.obj,'step1');this.obj.querySelector('textarea').value='';this.stars.reset();this.obj.show();},hide:function(){this.init();this.obj.hide();},onStarsChanged:function(stars){if(stars<5){DataStorage.setLocal('feedback_stars',stars);Html.addClass(this.obj,'step1');stat("RateUs","step1","stars selected",stars);return;}
stat("RateUs","five_stars","stars selected",stars);var a=document.createElement('a');a.target='_blank';if(State.isIos()){a.href='https://itunes.apple.com/app/anonymous-chat-for-two/id1398177426';a.click();}else if(State.isAmazon()){a.href='amzn://apps/android?p='+Native.getAppPackage()+'&referrer=rateus';a.click();}else if(State.isAndroid()){a.href='market://details?id='+Native.getAppPackage()+'&referrer=rateus';a.click();}
DataStorage.setLocal('feedback_stars',stars);this.hide();},btn_dont_show:function(){stat("RateUs","btn_dont_show");DataStorage.setLocal('feedback_stars',0);this.hide();},btn_ask_later:function(){stat("RateUs","btn_ask_later");DataStorage.setSession('feedback_stars',0);this.hide();},btn_done:function(){stat("RateUs","btn_done");DataStorage.setLocal('feedback_text',this.obj.querySelector('textarea').value);this.hide();}};TabsComm.init();window.onload=function(){if(typeof(Theme)!=='undefined'){Theme.init();}
if(ons.platform.isIPhoneX()){document.body.className+=' iphonex';}
if(typeof(Native)!=='undefined'){if(Native.onAppLoaded)Native.onAppLoaded();Native.onKeyboardStateChange=function(state){switch(state){case "OPENING":if(ons.platform.isIPhoneX()){document.body.className=document.body.className+' keyboard_open';}
break;case "CLOSING":if(ons.platform.isIPhoneX()){document.body.className=document.body.className.replace(/keyboard_open/,'');}
break;case "OPENED":case "CLOSED":UI.scrollDown();}};if(Native.getTopMargin){}
if(Native.getBottomMargin){}
document.body.className+=' webview';State.webview=true;}else{document.body.className+=' web';}};document.addEventListener("DOMContentLoaded",function(event){TabsComm.sendEvent(TabsComm.TYPE.ACTIVE_TAB_PING);if(ons.platform.isAndroid()){}else{}
if(!ons.platform.isAndroid()&&!ons.platform.isIOS()&&!ons.platform.isBlackBerry()){SizeOptimizer.optimize();window.addEventListener("optimizedResize",SizeOptimizer.optimize);}
var platform="desktop";if(ons.platform.isAndroid()){platform="android";}else if(ons.platform.isIOS){platform="ios";}
document.body.className+=' '+platform;if(true||!ons.platform.isWebView()){ons.forcePlatformStyling('iOS');document.body.className+=" platform_ios";}else{document.body.className+=" platform_"+platform;}
State.setPlatform(platform);ons.enableAutoStatusBarFill();if(ons.platform.isIPhoneX()){document.documentElement.setAttribute('onsflag-iphonex-portrait','');document.documentElement.setAttribute('onsflag-iphonex-landscape','');}
if(!DataStorage.getLocal('first_launch')){DataStorage.setLocal('first_launch',new Date()/1000|0)}
DataStorage.setLocal('last_launch',new Date()/1000|0);HistoryAPI.init();ChatHistory.init();UI.init();Stat.init();Chat.init(C.ws_url);});document.addEventListener('init',function(event){var page=event.target;if(page.id==='page_start'){Chat.disconnect();if(typeof(Sidebar)!=='undefined'){Sidebar.init(page);}else{var btn=page.querySelector(".sidebarBtn");if(btn)btn.parentNode.removeChild(btn);var sidebar=document.getElementById('sidebar');if(sidebar)sidebar.parentNode.removeChild(sidebar);}
page.querySelector('#btn-start').onclick=function(){if(!DataStorage.getLocal('eula_accepted',false)){ons.notification.alert(T.tos_short_body,{buttonLabels:[T.tos_short_btn_read_all,T.tos_short_btn_confirm],primaryButtonIndex:0,cancelable:true,title:T.tos_short_title,modifier:"alert-tos",callback:function(btn_index){if(!btn_index){UI.pushPage('terms-of-service.html');}else{DataStorage.setLocal('eula_accepted',true);UI.pushPage('page_chat.tpl');}}});return;}
UI.pushPage('page_chat.tpl');};var nickname=DataStorage.getLocal('nickname',C.rname);page.querySelector('#nickname').value=nickname;DataStorage.setLocal('nickname',nickname);page.querySelector('#nickname').oninput=function(event){var nickname=event.target.value;if(nickname===''){DataStorage.delLocal('nickname');}else{DataStorage.setLocal('nickname',nickname);}};var fn_static_click=function(el){UI.pushPage(el.target.href);return false;};var btns=page.querySelectorAll('.link-static');for(i=0;i<btns.length;i++){btns[i].onclick=fn_static_click;}
setTimeout(function(){if(!UI.active)return;if(window.location.pathname==='/r'||window.location.host.indexOf("r.")===0){UI.pushPage('page_restore_chat.tpl');return;}
if(C.restore_session){Chat.setState(Chat.STATE.RESTORING);}else if(DataStorage.getLocal('do_state_restore',false)!==true){Chat.setState(Chat.STATE.IDLE);}
if(DataStorage.getLocal('chat_state')!==Chat.STATE.IDLE||__url.search.indexOf('start=1')>0){page.querySelector('#btn-start').click();DataStorage.delLocal('do_state_restore');}},100);}else if(page.id==='page_chat.tpl'){Notifications.init();ReportModal.init(page);var w=document.getElementById('btn-send').offsetWidth;var msg=document.getElementById('message');msg.style.marginLeft=w+"px";msg.style.marginRight=w+"px";document.getElementById('btn-next').onclick=function(){if(Chat.state!==Chat.STATE.IN_PROGRESS){Chat.nextChat();return;}
ons.notification.confirm({message:T.confirmation_next_chat,callback:function(answer){if(answer)Chat.nextChat();}});};page.querySelector('ons-back-button').onClick=HistoryAPI.onbackbutton;document.querySelector('#message').oninput=function(event){Chat.sendTyping(event.target.value.trim());};UIMessages.init(document.getElementById('msg-list'));CameraUI.init();Chat.initPage();}else if(page.hasAttribute('static_page')){var t=page.querySelector('ons-toolbar');t.className=t.className.replace(/hidden/,'');page.querySelector('ons-back-button').onClick=function(){UI.popPage();};}else if(page.id==='page_restore_chat.tpl'){document.getElementById('btn_restore').onclick=function(){var code=document.getElementById('input_restore_code').value.trim();if(code.length!==8){alert(T.restore_chat_err_enter_correct_code);return;}
UI.showLoading(T.restore_chat_modal_checking);Xhr.PostFile("/rcheck",{code:code},function(session_id,http_code){if(http_code!==200||!session_id){UI.hideLoading();alert(T.restore_chat_err_incorrect_code);return;}
setTimeout(function(){UI.hideLoading();DataStorage.set(C.sess_cookie_name,session_id);DataStorage.setSession("restore_sess_id",session_id);document.querySelector('#myNavigator').replacePage("page_chat.tpl");console.log(UI.getCurrentPage().id);},200)});};var value=__url.search.replace(/^[#?]/,'');if(value.length===8){document.getElementById('input_restore_code').value=value;document.getElementById('btn_restore').click();}
history.replaceState({},"","/");}else if(page.id==='page_chat_history.tpl'){PageChatHistory.initPage(page);}else if(page.id==='page_saved_dialogs.tpl'){PageSavedDialogs.initPage(page);}});